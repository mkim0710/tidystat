---
# https://forum.posit.co/t/when-to-use-yaml-vs-when-to-use-setup-code-chunk/56169/
title: "`r params$doc_title`"
author: "MHKim"
date: "`r Sys.setlocale('LC_ALL', 'en_US.utf8'); format(Sys.time(), '%B %d, %Y')`"
output:
  html_notebook:  
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: false
      smooth_scroll: false
    number_sections: false
    code_folding: none
    df_print: tibble
    highlight: textmate
    fig_width: 10
    fig_height: 6
  html_document:
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: false
      smooth_scroll: false
    number_sections: false
    df_print: tibble
    code_folding: none
    highlight: textmate
    fig_width: 10
    fig_height: 6
  pdf_document: 
    toc: yes
    toc_depth: 6
    fig_width: 10
    fig_height: 6
    latex_engine: xelatex  # mainfont, sansfont, monofont, mathfont works only with xelatex and lualatex, but not pdflatex
    keep_tex: true
  word_document:
    toc: yes
    toc_depth: 6
    fig_width: 9
    fig_height: 6
# documentclass: scrartcl  # https://pandoc.org/MANUAL.html#variables-for-latex
# classoption: fontsize=9pt 
geometry: portrait, a3paper, margin=20mm # https://bookdown.org/yihui/rmarkdown/pdf-document.html#latex-options
# fontsize: 12pt
header-includes: 
  - \usepackage{fontspec}
  - \newcommand{\setfallbackfont}[4]{
      \IfFontExistsTF{#2}
        {#1{#2}}
        {\IfFontExistsTF{#3}
          {#1{#3}}
          {#1{#4}}}}
  # - \setfallbackfont{\setmainfont}{Roboto Condensed}{Noto Sans Condensed}{Arial Narrow}
  # - \setfallbackfont{\setsansfont}{Roboto Condensed}{Noto Sans Condensed}{Arial Narrow}
  - \setfallbackfont{\setmainfont}{Roboto}{Noto Sans}{Arial}
  - \setfallbackfont{\setsansfont}{Roboto}{Noto Sans}{Arial}
  - \setfallbackfont{\setmonofont}{Cascadia Code SemiBold}{Cascadia Code}{Fira Code}
  - \usepackage[hangul]{kotex}
  - \setfallbackfont{\setmainhangulfont}{NanumGothic}{HCR Dotum LVT}{Malgun Gothic}
  - \setfallbackfont{\setsanshangulfont}{NanumGothic}{HCR Dotum LVT}{Malgun Gothic}
  - \setfallbackfont{\setmonohangulfont}{D2Coding}{NanumGothicCoding}{NanumGothic}
params:
  doc_title: !r basename(rstudioapi::getSourceEditorContext()$path)
# https://stackoverflow.com/questions/55751815/r-markdown-difference-between-parameters-and-variables
# ?rmarkdown::html_document
---
<!-- https://stackoverflow.com/questions/28480625/r-knitr-markown-setting-html-page-width -->
<style type="text/css">
.main-content, .toc {max-width: 785px; margin: 0 auto; font-size: 1rem;} /* A4: 21cm x 29.7cm = 8.27in x 11.69in; 8.27in x 96px/in â‰ˆ 793px */
html { font-size: 12px; }
body { font-size: 12px; font-family: 'Roboto Condensed', 'Noto Sans Condensed', 'Open Sans Condensed', 'Source Sans 3', 'Arial Narrow', Helvetica, sans-serif; }
h1.title { font-size: 28px; font-family: 'Roboto Serif', 'Noto Serif', 'Source Serif 4', serif; line-height: 1.1; margin-top: 14px; margin-bottom: 0; color: Navy; }
h1 { font-size: 24px; font-family: 'Roboto Serif', 'Noto Serif', 'Source Serif 4', serif; line-height: 1.1; margin-top: 12px; margin-bottom: 0; color: Navy; }
h2 { font-size: 21px; font-family: 'Roboto Serif', 'Noto Serif', 'Source Serif 4', serif; line-height: 1.1; margin-top: 11px; margin-bottom: 0; color: Navy; }
h3 { font-size: 18px; font-family: 'Roboto Serif', 'Noto Serif', 'Source Serif 4', serif; line-height: 1.1; margin-top: 9px; margin-bottom: 0; color: Navy; }
h4 { font-size: 16px; font-family: 'Roboto Serif', 'Noto Serif', 'Source Serif 4', serif; line-height: 1.1; margin-top: 8px; margin-bottom: 0; color: Navy; }
h5 { font-size: 14px; font-family: 'Roboto Serif', 'Noto Serif', 'Source Serif 4', serif; line-height: 1.1; margin-top: 7px; margin-bottom: 0; color: Navy; }
h6 { font-size: 12px; font-family: 'Roboto Serif', 'Noto Serif', 'Source Serif 4', serif; line-height: 1.1; margin-top: 6px; margin-bottom: 0; color: Navy; }
table, td, th, figure, figcaption { font-size: 10px; font-family: 'Roboto Condensed', 'Noto Sans Condensed', 'Open Sans Condensed', 'Source Sans 3', 'Arial Narrow', Helvetica, sans-serif; line-height: 1.1; margin-top: 5px; margin-bottom: 0; }
code { font-size: 11px; font-family: 'Cascadia Code SemiBold', 'Cascadia Code', 'Fira Code', Consolas, 'Source Code Pro', monospace; line-height: 1.1; margin-top: 6px; margin-bottom: 0; color: DimGray; background-color: Snow; }
pre { font-size: 11px; font-family: 'Cascadia Code SemiBold', 'Cascadia Code', 'Fira Code', Consolas, 'Source Code Pro', monospace; line-height: 1.1; margin-top: 6px; margin-bottom: 0; color: DimGray; background-color: Snow; }
</style>
  
<!-- font-size: 0.9em; /* 90% of inherited font size */ -->
  
<!-- Body text (body): The default font size is typically 16 pixels. -->
<!-- Paragraphs (p): Inherit the body's font size, so also typically 16 pixels. -->
<!-- List items (li): Inherit the body's font size, generally 16 pixels. -->
<!-- Headings (h1 to h6): The default sizes decrease with each level. For example: -->
<!-- h1: Typically around 32 pixels. -->
<!-- h2: Often around 24 pixels. -->
<!-- h3: Commonly around 18.72 pixels. -->
<!-- h4: Usually about 16 pixels. -->
<!-- h5: Generally around 13.28 pixels. -->
<!-- h6: Often about 10.72 pixels. -->
<!-- Blockquotes (blockquote): Usually inherit the body's font size, around 16 pixels. -->
<!-- Tables (table), table cells (td, th): Typically inherit the body's font size, so around 16 pixels. -->
<!-- Figures (figure) and figure captions (figcaption): Generally inherit the body's font size, so about 16 pixels. -->
<!-- 1: Approximately 8 pixels. -->
<!-- 2: Approximately 10 pixels. -->
<!-- 3: Approximately 12 pixels (this was often considered the default size). -->
<!-- 4: Approximately 14 pixels. -->
<!-- 5: Approximately 18 pixels. -->
<!-- 6: Approximately 24 pixels. -->
# __________|------  
<!-- {r Rstudio-RMarkDown-Shortcuts, eval=FALSE, include=FALSE} -->
<!-- ##### Rstudio RMarkDown Shortcuts -->
<!-- https://support.posit.co/hc/en-us/articles/200711853-Keyboard-Shortcuts-in-the-RStudio-IDE   -->
<!-- https://bookdown.org/yihui/rmarkdown-cookbook/rstudio-shortcuts.html   -->
<!-- Insert R chunk	Ctrl+Alt+I	Command+Option+I   -->
<!-- Preview HTML	Ctrl+Shift+K	Command+Shift+K   -->
<!-- Run all chunks above	Ctrl+Alt+P	Command+Option+P   -->
<!-- Run current chunk	Ctrl+Alt+C	Command+Option+C   -->
<!-- Run current chunk	Ctrl+Shift+Enter	Command+Shift+Enter   -->
<!-- Run next chunk	Ctrl+Alt+N	Command+Option+N   -->
<!-- Run all chunks	Ctrl+Alt+R	Command+Option+R   -->
<!-- Go to next chunk/title	Ctrl+PgDown	Command+PgDown   -->
<!-- Go to previous chunk/title	Ctrl+PgUp	Command+PgUp   -->
<!-- Show/hide document outline	Ctrl+Shift+O	Command+Shift+O   -->
<!-- F7 spell-check your document.   -->
<!-- Restart the R session   Ctrl + Alt + F10 (or Command + Option + F10 on macOS).   -->
<!--    -->
<!-- *** Caution: @ # \$ \% * \\ ***  -->

  
```{r setup, echo=FALSE, results="hide"}
# ```{r setup, eval=TRUE, include=FALSE}
if(Sys.info()["sysname"] == "Windows") Sys.setlocale("LC_ALL", "en_US.UTF-8")  # Note that setting category "LC_ALL" sets only categories "LC_COLLATE", "LC_CTYPE", "LC_MONETARY" and "LC_TIME".
# Sys.setlocale("LC_MESSAGES", "en_US.utf8")  # Note that the LANGUAGE environment variable has precedence over "LC_MESSAGES" in selecting the language for message translation on most R platforms.  # LC_MESSAGES does not exist in Windows
Sys.setenv(LANGUAGE="en_US");  # Sys.getenv("LANGUAGE");    # Note that the LANGUAGE environment variable has precedence over "LC_MESSAGES" in selecting the language for message translation on most R platforms.
# str(knitr::opts_chunk$get())
# cat(deparse(knitr::opts_chunk$get(), width.cutoff=120), "  \n", sep="")
# list(eval=TRUE, echo=TRUE, results = "markup", tidy = FALSE, tidy.opts = NULL, collapse = FALSE, prompt = FALSE, comment = "##",     highlight = TRUE, size = "normalsize", background = "#F7F7F7", strip.white = structure(TRUE, class = "AsIs"), cache = FALSE,     cache.path = "cache/", cache.vars = NULL, cache.lazy = TRUE, dependson = NULL, autodep = FALSE, cache.rebuild = FALSE,     fig.keep = "high", fig.show = "asis", fig.align = "default", fig.path = "figure/", dev = NULL, dev.args = NULL, dpi = 72,     fig.ext = NULL, fig.width=7, fig.height=7, fig.env = "figure", fig.cap = NULL, fig.scap = NULL, fig.lp = "fig:",     fig.subcap = NULL, fig.pos = "", out.width=NULL, out.height=NULL, out.extra = NULL, fig.retina = 1, external = TRUE,     sanitize = FALSE, interval = 1, aniopts = "controls,loop", warning = TRUE, error = TRUE, message = TRUE, render = NULL,     ref.label = NULL, child = NULL, engine = "R", split = FALSE, include = TRUE, purl = TRUE)
knitr::opts_chunk$set(
    eval=TRUE, echo=FALSE, results="markup", collapse=TRUE, # In Rstudio Notebook Source Pane & nb.HTML, results="hold" does not work
    comment="#", fig.width=10, fig.height=6, # In Rstudio Notebook Source Pane & nb.HTML, comment="##" does not work?
    warning=TRUE, message=TRUE, include=TRUE, 
    error=FALSE,  # error=TRUE: show the errors without stopping R; error=FALSE: stop on error
    tidy.opts=list(width.cutoff=120), tidy=FALSE, 
    R.options = list(width=120), paged.print=FALSE
) 
# knitr::opts_chunk$set(message=TRUE) & {r, results="hide"} -> message shown in Rstudio Notebook Source Pane & knitted HTML, but not in Preview nb.HTML?!
# knitr::opts_chunk$set(message=FALSE) & {r, message=TRUE, results="hide"} -> message shown in Rstudio Notebook Source Pane & knitted HTML, but not in Preview nb.HTML?!
# *** results="hide": results shown only on Rstudio Notebook Source Pane, but not in nb.HTML nor knitted HTML
knitr::opts_knit$set(global.par = TRUE)


# ```{r loadPackages-NoEchoHideResults, echo=FALSE, results="hide"}
##%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
# cmd /C C:/PROGRA~2/MICROS~1/Edge/APPLIC~1/msedge_proxy.exe --app=https://github.com/mkim0710/tidystat/blob/master/rstudio-prefs/templates/default.R
# cmd /C C:/PROGRA~2/MICROS~1/Edge/APPLIC~1/msedge_proxy.exe --app=https://github.com/mkim0710/tidystat/blob/master/rstudio-prefs/templates/templates-00env1.minimum.Rmd
##%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
# cmd /C C:/PROGRA~2/MICROS~1/Edge/APPLIC~1/msedge_proxy.exe --app=https://github.com/mkim0710/tidystat/blob/master/.Rprofile    
#| ------------------------- < To be covered at .Rprofile > --------------------- |#  
if(!exists("env1", envir=.GlobalEnv)) {  message('> source("https://raw.githubusercontent.com/mkim0710/tidystat/master/.Rprofile")')  ;  source("https://raw.githubusercontent.com/mkim0710/tidystat/master/.Rprofile")  ;  .First()  }  
if(!".Rprofile" %in% names(.GlobalEnv$env1$source)) {  message('> source("https://raw.githubusercontent.com/mkim0710/tidystat/master/.Rprofile")')  ;  source("https://raw.githubusercontent.com/mkim0710/tidystat/master/.Rprofile")  ;  .First()  }  
##________________________________________________________________________________  
##%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
env1$info$options.width = options()$width; cat(options()$width, "  \n", sep="")
# ```
#   
# <font size="3">\% env1</font>  
#   
# ```{r env1-Info-NoEchoHideResults, echo=FALSE, results="hide"}
# https://yihui.org/knitr/options/#package-options
env1$info$info_software_versions = env1$env.internal.attach$get_software_versions(library_names = c("tidyverse", "dplyr", "ggplot2", "purrr", "stringr", "stats","survival"))
# str(env1$info$info_software_versions)


###### env1\$info\$DocumentTitle1 ----  
# ```{r env1-DocumentTitle1-NoEchoHideResults, echo=FALSE, results="hide"}
env1$info$DocumentTitle0 = paste0("00env1.minimum","-",basename(getwd()))
env1$info$DocumentTitle1 = paste0(env1$info$DocumentTitle0,"@", ifelse(grepl("MacBook-Pro", Sys.info()["nodename"]), "MBP", Sys.info()["nodename"]))
cat(env1$info$DocumentTitle0,"-",format(Sys.time(),"%y%m%d"), "\n", 
    env1$info$DocumentTitle0,"-",format(Sys.time(),"%y%m%d"),".Rmd", "\n", 
    env1$info$DocumentTitle0,"-dev",format(Sys.time(),"%y%m%d"),".Rmd", "\n", 
    env1$info$DocumentTitle0,"-clean",format(Sys.time(),"%y%m%d"),".Rmd", "\n", 
    sep="")
```
  
  
```{r env1-Path-NoEchoNoMsgNoResults, echo=FALSE, warning=TRUE, message=NA, results="hide"}
###### env1\$path ----  
# cat(" getwd() == "); dput(getwd()) #----   
##%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
### env1\$path\$LastSourceEditorContext.path_filename.ext ====  
# *** Caution) In Rstudio Notebook, the path of the running Rmd file is set as the working directory~!!!
# env1$path$LastSourceEditorContext.path_filename.ext = rstudioapi::getSourceEditorContext()$path |> normalizePath(winslash="/") |> str_replace(fixed(getwd()|>normalizePath(winslash="/")), "") |> str_replace("^/", "")
env1$path$LastSourceEditorContext.path_filename.ext = rstudioapi::getSourceEditorContext()$path |> normalizePath(winslash="/") |> str_replace(fixed(env1$path$path1|>normalizePath(winslash="/")), "") |> str_replace("^/", "")
##%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
# env1$path$project_base = "Rproject_HEALS0215"
# env1$path$data_suffix = "_01"
# # env1$path$data_suffix = ""
# env1$path$project_suffix = "GJ3"
##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
# env1$path$.path4read = file.path(env1$path$path0, paste0(env1$path$project_base, env1$path$data_suffix))
# env1$path$.path4write = file.path(env1$path$.path4read, paste0(env1$path$project_base, env1$path$data_suffix, env1$path$project_suffix))
env1$path$.path4read = ifelse(is.na(env1$path$path1), getwd(), env1$path$path1)
env1$path$.path4write = getwd()
.path4read  = env1$path$.path4read
.path4write = env1$path$.path4write
# cat(" > str(env1$path)\n"); str(env1$path, max.level = 1, give.attr = F)  

## @ env1 |> as.list() |> str(max.level = 2, give.attr = FALSE) ----  
"ls(all.names = TRUE, envir = .GlobalEnv) |> set_names() |> map(get) |> str(max.level = 1, give.attr = FALSE)" |> env1$f$f_CodeText.echo(Execute = TRUE, deparse_cat = FALSE, LinePrefix4CodeText = "> ", LinePrefix4Output = "")
cat("    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++    \n")
".tmp |> str(max.level = 1, give.attr = FALSE)" |> env1$f$f_CodeText.echo(Execute = TRUE, deparse_cat = FALSE, LinePrefix4CodeText = "> ", LinePrefix4Output = "")
cat("    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++    \n")
"env1 |> as.list() |> env1$f$f_list.str_by_element(max.level = 2, give.attr = FALSE)" |> env1$f$f_CodeText.echo(Execute = TRUE, deparse_cat = FALSE, LinePrefix4CodeText = "> ", LinePrefix4Output = "")
##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
# .filename.source.r = "f_DataSetName.Search.read.checkEntity" |> paste0(".source.r"); .subpath=r"()"|>str_replace_all("\\\\","/"); env1$f$f_sourcePath.execute_if_not_sourced(.subpath_filename.source.r = paste0(.subpath,ifelse(.subpath=="","","/"),.filename.source.r))
# if (getwd() != .path4write) warning("getwd() != .path4write  == ") else cat(" getwd() == .path4write == "); dput(.path4write)  #----  
```
  
  
# __________|------  
# @@ START) data example ----  
  
# __________|------  
# @@ START) dev ----  
```{r env0-NoEchoNoResults, echo=FALSE, results="hide"}
env0 = env1
```
  
  
# __________|------  
# @@ START) function ----  
https://chatgpt.com/c/66e7deba-b85c-800e-9f76-124d9087e1a7
## \% |> f.updateTemplates() ----  
```{r, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="#", R.options=list(width=120)}
options(width=120)
# ## \$ f.updateTemplates =  ----  
# # https://github.com/mkim0710/f.updateTemplates.exe.r  
# .tmp$objectname = "f.updateTemplates"
# .tmp$object = function(list_formula) {
#     #@ The Templates of RStudio (default.R, notebook.Rmd) ++++++++++++
#     if (Sys.info()["sysname"] == "Windows") {.path4APPDATA_RStudio = file.path(Sys.getenv("APPDATA"), "RStudio")} else if (.Platform$OS.type == "unix") {.path4APPDATA_RStudio = "~/.config/rstudio"}
#     if(!dir.exists(file.path(.path4APPDATA_RStudio, "templates"))) dir.create(file.path(.path4APPDATA_RStudio, "templates"))
#     # # \% Edit the templates of RStudio (default.R, notebook.Rmd) ~~~~~~~~~~~~
#     # "default.R" %>% file.path(.path4APPDATA_RStudio, "templates", .) %>% {.[file.exists(.)]} |> file.edit(); if(!is.null(env1$path$LastSourceEditorContext.path_filename.ext)) if(env1$path$LastSourceEditorContext.path_filename.ext != "") file.edit(paste0(env1$path$path1,"/",env1$path$LastSourceEditorContext.path_filename.ext))
#     # "notebook.Rmd" %>% file.path(.path4APPDATA_RStudio, "templates", .) %>% {.[file.exists(.)]} |> file.edit(); if(!is.null(env1$path$LastSourceEditorContext.path_filename.ext)) if(env1$path$LastSourceEditorContext.path_filename.ext != "") file.edit(paste0(env1$path$path1,"/",env1$path$LastSourceEditorContext.path_filename.ext))
#     # \% Update the templates of RStudio (default.R, notebook.Rmd)  ~~~~~~~~~~~~
#     download.file("https://raw.githubusercontent.com/mkim0710/tidystat/master/rstudio-prefs/templates/default.R", destfile = file.path(.path4APPDATA_RStudio, "templates", "default.R"))
#     download.file("https://raw.githubusercontent.com/mkim0710/tidystat/master/rstudio-prefs/templates/templates-00env1.minimum.Rmd", destfile = file.path(.path4APPDATA_RStudio, "templates", "notebook.Rmd"))
#     # for (filename.ext in c("default.R", "templates-00env1.minimum.Rmd")) {
#     #     if (filename.ext %in% dir()) {
#     #         env1$env.internal.attach$f_filename.ext.createBackup(backup_from_path_filename.ext = filename.ext, .backup_to_path="-backup", timeFormat="%y%m%d_%H", overwrite=TRUE)
#     #             download.file(paste0("https://raw.githubusercontent.com/mkim0710/tidystat/master/rstudio-prefs/templates/",filename.ext), destfile = filename.ext)
#     #     }
#     # }
#     if (Sys.info()["sysname"] == "Windows") {
#         # "D:/OneDrive/[][Rproject]/github_tidystat/rstudio-prefs/templates/default.R" |> source()
#         # Sys.setenv(PARENT_RENDERING = "YES"); "D:/OneDrive/[][Rproject]/github_tidystat/rstudio-prefs/templates/templates-00env1.minimum.Rmd" |> rmarkdown::render(output_dir = dirname(env1$path$LastSourceEditorContext.path_filename.ext), output_format = "html_notebook"); Sys.setenv(PARENT_RENDERING = "NO")
#         for (filename.ext in c("default.R", "templates-00env1.minimum.Rmd")) {
#             env1$env.internal.attach$f_filename.ext.createBackup(backup_from_path_filename.ext = paste0("D:/OneDrive/[][Rproject]/Rproject_Rmd/",filename.ext), .backup_to_path="D:/OneDrive/[][Rproject]/-backup", timeFormat="%y%m%d_%H", overwrite=TRUE)
#         }
#         browseURL("D:/OneDrive/[][Rproject]/-backup")
#         
#         for (filename.ext in c("default.R", "templates-00env1.minimum.Rmd")) {
#             download.file(paste0("https://raw.githubusercontent.com/mkim0710/tidystat/master/rstudio-prefs/templates/",filename.ext), destfile = paste0("D:/OneDrive/[][Rproject]/Rproject_Rmd/",filename.ext))
#         }
#     }
#     
# }
# ### \% |> f_function.load2env.internal(.tmp$objectname, env1_subenv_name) ---
# .tmp$env1_subenv_name = "env.internal"; env1$env.internal$f_function.load2env.internal(function_object = .tmp$object, function_name = .tmp$objectname, env1_subenv_name = .tmp$env1_subenv_name, show_packageStartupMessage = TRUE, function.reload = options()$function.reload, runLoadedFunction = FALSE)
```


## \% |> env1$env.internal.attach$f_file2.compare()  
```{r, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="#", R.options=list(width=120)}
options(width=120)
# Function to compare two source code files chunk-by-chunk using while loop with a chunk size of 64KB
env1$env.internal.attach$f_file2.compare <- function(file1, file2, chunk_size = 65536) {
    # Open both files in binary mode
    con1 <- file(file1, "rb")
    con2 <- file(file2, "rb")
    
    # Ensure files are closed after comparison
    on.exit({
        close(con1)
        close(con2)
    })
    
    # Initialize the first chunks
    chunk1 <- readBin(con1, what = "raw", n = chunk_size)
    chunk2 <- readBin(con2, what = "raw", n = chunk_size)
    
    # While at least one of the chunks has content, continue comparing
    while(length(chunk1) > 0 || length(chunk2) > 0) {
        # If the chunks differ, return FALSE
        if (!identical(chunk1, chunk2)) {
            return(FALSE)
        }
        
        # Read the next chunk for both files
        # The file pointer moves automatically as you read, so each call to readBin() continues where the last one left off.
        chunk1 <- readBin(con1, what = "raw", n = chunk_size)
        chunk2 <- readBin(con2, what = "raw", n = chunk_size)
    }
    
    # If all chunks are identical and EOF is reached for both files, return TRUE
    return(TRUE)
}
```


## \% |> env1$env.internal.attach$f_url_destfile.DownloadIfDifferent() 
```{r, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="#", R.options=list(width=120)}
# Function to download a file only if the web file is different from the local file
env1$env.internal.attach$f_url_destfile.DownloadIfDifferent <- function(url, destfile, chunk_size = 65536) {  # Default 64KB chunk size
    tryCatch({
        # Temporary file to download the remote file for comparison
        temp_file <- tempfile()
        download.file(url, temp_file, quiet = TRUE)
        
        # Compare the local file and the remote file (if local file exists)
        if (file.exists(destfile)) {
            files_are_identical <- env1$env.internal.attach$f_file2.compare(destfile, temp_file, chunk_size)
            
            if (files_are_identical) {
                message(paste("No update needed for:", destfile))
                return(FALSE)
            }
        }
        
        # If files are different or local file doesn't exist, proceed with the download
        file.copy(from = temp_file, to = destfile, overwrite = TRUE)
        message(paste("Downloaded updated file:", destfile))
        return(TRUE)
        
    }, error = function(e) {
        message(paste("Failed to download or update:", url))
        message("Error:", e$message)
        return(FALSE)
    })
}


#@ The Templates of RStudio (default.R, notebook.Rmd) ++++++++++++
    if (Sys.info()["sysname"] == "Windows") {.path4APPDATA_RStudio = file.path(Sys.getenv("APPDATA"), "RStudio")} else if (.Platform$OS.type == "unix") {.path4APPDATA_RStudio = "~/.config/rstudio"}
    if(!dir.exists(file.path(.path4APPDATA_RStudio, "templates"))) dir.create(file.path(.path4APPDATA_RStudio, "templates"))

env1$env.internal.attach$f_url_destfile.DownloadIfDifferent(url = "https://raw.githubusercontent.com/mkim0710/tidystat/master/rstudio-prefs/templates/default.R", destfile =  file.path(.path4APPDATA_RStudio, "templates", "default.R"))
```
  
  
## \$ env1\$f\$f.updateTemplates() ----  
```{r, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="#", R.options=list(width=120)}
options(width=120)
# https://github.com/mkim0710/f.updateTemplates.exe.r
env1$f$f.updateTemplates = function(.path4APPDATA_RStudio = NULL) {
    #@ The Templates of RStudio (default.R, notebook.Rmd) ++++++++++++
    # Assign .path4APPDATA_RStudio based on the platform if it's NULL
    if (is.null(.path4APPDATA_RStudio)) {
        if (Sys.info()["sysname"] == "Windows") {.path4APPDATA_RStudio = file.path(Sys.getenv("APPDATA"), "RStudio")} else if (.Platform$OS.type == "unix") {.path4APPDATA_RStudio = "~/.config/rstudio"}
    }
    
    # Create the templates directory if it doesn't exist
    if(!dir.exists(file.path(.path4APPDATA_RStudio, "templates"))) dir.create(file.path(.path4APPDATA_RStudio, "templates"))
    
    # # \% Edit the templates of RStudio (default.R, notebook.Rmd) ~~~~~~~~~~~~
    # "default.R" %>% file.path(.path4APPDATA_RStudio, "templates", .) %>% {.[file.exists(.)]} |> file.edit(); if(!is.null(env1$path$LastSourceEditorContext.path_filename.ext)) if(env1$path$LastSourceEditorContext.path_filename.ext != "") file.edit(paste0(env1$path$path1,"/",env1$path$LastSourceEditorContext.path_filename.ext))
    # "notebook.Rmd" %>% file.path(.path4APPDATA_RStudio, "templates", .) %>% {.[file.exists(.)]} |> file.edit(); if(!is.null(env1$path$LastSourceEditorContext.path_filename.ext)) if(env1$path$LastSourceEditorContext.path_filename.ext != "") file.edit(paste0(env1$path$path1,"/",env1$path$LastSourceEditorContext.path_filename.ext))
    
    # \% Update the templates of RStudio (default.R, notebook.Rmd)  ~~~~~~~~~~~~
    env1$env.internal.attach$f_url_destfile.DownloadIfDifferent("https://raw.githubusercontent.com/mkim0710/tidystat/master/rstudio-prefs/templates/default.R", destfile = file.path(.path4APPDATA_RStudio, "templates", "default.R"))
    env1$env.internal.attach$f_url_destfile.DownloadIfDifferent("https://raw.githubusercontent.com/mkim0710/tidystat/master/rstudio-prefs/templates/templates-00env1.minimum.Rmd", destfile = file.path(.path4APPDATA_RStudio, "templates", "notebook.Rmd"))
    # for (filename.ext in c("default.R", "templates-00env1.minimum.Rmd")) {
    #     if (filename.ext %in% dir()) {
    #         env1$env.internal.attach$f_filename.ext.createBackup(backup_from_path_filename.ext = filename.ext, .backup_to_path="-backup", timeFormat="%y%m%d_%H", overwrite=TRUE)
    #             download.file(paste0("https://raw.githubusercontent.com/mkim0710/tidystat/master/rstudio-prefs/templates/",filename.ext), destfile = filename.ext)
    #     }
    # }
    
    if (Sys.info()["sysname"] == "Windows") {
        # "D:/OneDrive/[][Rproject]/github_tidystat/rstudio-prefs/templates/default.R" |> source()
        # Sys.setenv(PARENT_RENDERING = "YES"); "D:/OneDrive/[][Rproject]/github_tidystat/rstudio-prefs/templates/templates-00env1.minimum.Rmd" |> rmarkdown::render(output_dir = dirname(env1$path$LastSourceEditorContext.path_filename.ext), output_format = "html_notebook"); Sys.setenv(PARENT_RENDERING = "NO")
        for (filename.ext in c("default.R", "templates-00env1.minimum.Rmd")) {
            env1$env.internal.attach$f_filename.ext.createBackup(backup_from_path_filename.ext = paste0("D:/OneDrive/[][Rproject]/Rproject_Rmd/",filename.ext), .backup_to_path="D:/OneDrive/[][Rproject]/-backup", timeFormat="%y%m%d_%H", overwrite=TRUE)
        }
        browseURL("D:/OneDrive/[][Rproject]/-backup")

        for (filename.ext in c("default.R", "templates-00env1.minimum.Rmd")) {
            env1$env.internal.attach$f_url_destfile.DownloadIfDifferent(paste0("https://raw.githubusercontent.com/mkim0710/tidystat/master/rstudio-prefs/templates/",filename.ext), destfile = paste0("D:/OneDrive/[][Rproject]/Rproject_Rmd/",filename.ext))
        }
    }

}
env1$f$f.updateTemplates()
```
  
  
## \% |> isRemoteFileDifferent() ----  
```{r, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="#", R.options=list(width=120)}
options(width=120)
# library(httr)
# 
# # Function to check if the remote file has changed using HTTP headers
# isRemoteFileDifferent <- function(url, destfile) {
#     # Make a HEAD request to get the headers of the remote file
#     response <- HEAD(url)
#     
#     # Extract the Last-Modified header from the remote file
#     remote_last_modified <- headers(response)$`last-modified`
#     
#     # Extract ETag header from the remote file
#     remote_etag <- headers(response)$etag
#     
#     # Debugging prints to inspect header values
#     message("Remote Last-Modified: ", remote_last_modified)
#     message("Remote ETag: ", remote_etag)
#     
#     # Get the local file's last modification time
#     if (file.exists(destfile)) {
#         local_last_modified <- format(file.info(destfile)$mtime, "%a, %d %b %Y %H:%M:%S GMT")
#         
#         # Debugging prints to inspect local file values
#         message("Local Last-Modified: ", local_last_modified)
#         
#         # Compare Last-Modified times
#         if (!is.null(remote_last_modified) && remote_last_modified == local_last_modified) {
#             message("Local file is up-to-date with the remote file (Last-Modified).")
#             return(FALSE)
#         }
#         
#         # Debugging: If Last-Modified does not match, check ETag
#         local_etag <- attr(file.info(destfile), "etag")  # Placeholder for ETag (you need to store ETag locally)
#         message("Local ETag: ", local_etag)
#         
#         if (!is.null(remote_etag) && !is.null(local_etag) && remote_etag == local_etag) {
#             message("Local file matches remote file based on ETag.")
#             return(FALSE)
#         }
#     } else {
#         message("Local file does not exist.")
#     }
#     
#     # If no match or file does not exist, the files are different
#     return(TRUE)
# }
# 
# # Function to download the file only if it differs from the local version
# safeDownloadFileIfDifferent <- function(url, destfile, chunk_size = 65536) {
#     tryCatch({
#         # Check if the remote file differs from the local one using headers
#         if (isRemoteFileDifferent(url, destfile)) {
#             # Proceed to download the file if they are different
#             download.file(url, destfile, quiet = TRUE)
#             message(paste("Downloaded updated file:", destfile))
#             return(TRUE)
#         } else {
#             message(paste("No update needed for:", destfile))
#             return(FALSE)
#         }
#         
#     }, error = function(e) {
#         message(paste("Failed to download or update:", url))
#         message("Error:", e$message)
#         return(FALSE)
#     })
# }
# 
# # Test case
# test_url1 <- "https://raw.githubusercontent.com/mkim0710/tidystat/master/rstudio-prefs/templates/default.R"
# local_file1 <- "test_default.R"
# 
# safeDownloadFileIfDifferent(test_url1, local_file1)
# # Remote Last-Modified: 
# # Remote ETag: W/"6cadf88b6acf4df2009bf12a34306611c39c4989d16e1ac30ffe7a5315f9785e"
# # Local Last-Modified: Mon, 16 Sep 2024 17:03:53 GMT
# # Local ETag: 
# # Downloaded updated file: test_default.R
# # [1] TRUE
```
  
  
## \% |> isRemoteFileDifferent() ----  
```{r, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="#", R.options=list(width=120)}
options(width=120)
library(httr)

# Function to check if the remote file has changed using HTTP headers
isRemoteFileDifferent <- function(url, destfile) {
    # Make a HEAD request to get the headers of the remote file
    response <- HEAD(url)
    
    # Extract the ETag header from the remote file
    remote_etag <- headers(response)$etag
    
    # Define path for storing the local ETag
    etag_file <- paste0(destfile, ".etag")
    
    # Debugging prints to inspect header values
    message("Remote ETag: ", remote_etag)
    
    # Check if the local file exists and if an ETag file exists
    if (file.exists(destfile) && file.exists(etag_file)) {
        # Read the stored local ETag
        local_etag <- readLines(etag_file)
        
        # Debugging prints for local ETag
        message("Local ETag: ", local_etag)
        
        # Compare ETags
        if (!is.null(remote_etag) && remote_etag == local_etag) {
            message("Local file is up-to-date with the remote file (ETag).")
            return(FALSE)
        }
    } else {
        message("Local file or ETag file does not exist.")
    }
    
    # If no match or file does not exist, the files are different
    return(TRUE)
}

# Function to download the file only if it differs from the local version
safeDownloadFileIfDifferent <- function(url, destfile, chunk_size = 65536) {
    tryCatch({
        # Check if the remote file differs from the local one using headers
        if (isRemoteFileDifferent(url, destfile)) {
            # Proceed to download the file if they are different
            download.file(url, destfile, quiet = TRUE)
            
            # Extract the ETag from the remote response
            response <- HEAD(url)
            remote_etag <- headers(response)$etag
            
            # Save the ETag locally
            etag_file <- paste0(destfile, ".etag")
            writeLines(remote_etag, etag_file)
            
            message(paste("Downloaded updated file:", destfile))
            return(TRUE)
        } else {
            message(paste("No update needed for:", destfile))
            return(FALSE)
        }
        
    }, error = function(e) {
        message(paste("Failed to download or update:", url))
        message("Error:", e$message)
        return(FALSE)
    })
}

# Test case
test_url1 <- "https://raw.githubusercontent.com/mkim0710/tidystat/master/rstudio-prefs/templates/default.R"
local_file1 <- "test_default.R"

safeDownloadFileIfDifferent(test_url1, local_file1)
safeDownloadFileIfDifferent(test_url1, local_file1)
# Remote ETag: W/"6cadf88b6acf4df2009bf12a34306611c39c4989d16e1ac30ffe7a5315f9785e"
# Local file or ETag file does not exist.
# Downloaded updated file: test_default.R
# [1] TRUE
# Remote ETag: W/"6cadf88b6acf4df2009bf12a34306611c39c4989d16e1ac30ffe7a5315f9785e"
# Local ETag: W/"6cadf88b6acf4df2009bf12a34306611c39c4989d16e1ac30ffe7a5315f9785e"
# Local file is up-to-date with the remote file (ETag).
# No update needed for: test_default.R
# [1] FALSE
```
  
  
## \% |> isRemoteFileDifferent() ----  
```{r, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="#", R.options=list(width=120)}
options(width=120)
library(httr)

library(httr)

# Function to check if the remote file has changed using HTTP headers
isRemoteFileDifferent <- function(url, destfile) {
    # Make a HEAD request to get the headers of the remote file
    response <- HEAD(url)
    
    # Extract the ETag header from the remote file
    remote_etag <- headers(response)$etag
    
    # Define the path for storing the local ETag
    etag_file <- paste0(destfile, ".etag")
    
    # Debugging prints to inspect ETag values
    message("Remote ETag: ", remote_etag)
    
    # Check if the local file and the ETag file exist
    if (file.exists(destfile) && file.exists(etag_file)) {
        # Read the stored local ETag
        local_etag <- readLines(etag_file)
        
        # Debugging prints for local ETag
        message("Local ETag: ", local_etag)
        
        # Compare ETags
        if (!is.null(remote_etag) && remote_etag == local_etag) {
            message("Local file is up-to-date with the remote file (ETag).")
            return(FALSE)
        }
    } else {
        message("Local file or ETag file does not exist.")
    }
    
    # If no match or file does not exist, the files are different
    return(TRUE)
}

# Function to download the file only if it differs from the local version
safeDownloadFileIfDifferent <- function(url, destfile, chunk_size = 65536) {
    tryCatch({
        # Check if the remote file differs from the local one using headers
        if (isRemoteFileDifferent(url, destfile)) {
            # Proceed to download the file if they are different
            download.file(url, destfile, quiet = TRUE)
            
            # Extract the ETag from the remote response
            response <- HEAD(url)
            remote_etag <- headers(response)$etag
            
            # Save the ETag locally in the .etag file
            etag_file <- paste0(destfile, ".etag")
            writeLines(remote_etag, etag_file)
            
            message(paste("Downloaded updated file:", destfile))
            return(TRUE)
        } else {
            message(paste("No update needed for:", destfile))
            return(FALSE)
        }
        
    }, error = function(e) {
        message(paste("Failed to download or update:", url))
        message("Error:", e$message)
        return(FALSE)
    })
}

# Test case
test_url1 <- "https://raw.githubusercontent.com/mkim0710/tidystat/master/rstudio-prefs/templates/default.R"
local_file1 <- "test_default.R"

safeDownloadFileIfDifferent(test_url1, local_file1)

safeDownloadFileIfDifferent(test_url1, local_file1)

```
  
  
###### \% |> isRemoteFileDifferentBySize() ----  
```{r, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="#", R.options=list(width=120)}
options(width=120)
library(httr)

# Function to check if the remote file size differs from the local file size
isRemoteFileDifferentBySize <- function(url, destfile) {
    # Make a HEAD request to get the headers of the remote file
    response <- HEAD(url)
    
    # Extract the Content-Length header (file size) from the remote file
    remote_size <- as.numeric(headers(response)$`content-length`)
    
    # Debugging print to inspect the remote file size
    message("Remote file size: ", remote_size)
    
    # Check if the local file exists
    if (file.exists(destfile)) {
        # Get the size of the local file
        local_size <- file.info(destfile)$size
        
        # Debugging print to inspect the local file size
        message("Local file size: ", local_size)
        
        # Compare file sizes
        if (!is.null(remote_size) && remote_size == local_size) {
            message("Local file is up-to-date with the remote file (File size).")
            return(FALSE)
        }
    } else {
        message("Local file does not exist.")
    }
    
    # If no match or file does not exist, the files are different
    return(TRUE)
}

# Function to download the file using httr to avoid extra metadata issues
safeDownloadFileIfDifferent <- function(url, destfile) {
    tryCatch({
        # Check if the remote file differs from the local one using file size
        if (isRemoteFileDifferentBySize(url, destfile)) {
            # Use httr's GET request to download the file correctly
            response <- GET(url)
            
            if (status_code(response) == 200) {
                writeBin(content(response, "raw"), destfile)
                message(paste("Downloaded updated file:", destfile))
                return(TRUE)
            } else {
                message("Failed to download file. Status code: ", status_code(response))
                return(FALSE)
            }
        } else {
            message(paste("No update needed for:", destfile))
            return(FALSE)
        }
        
    }, error = function(e) {
        message(paste("Failed to download or update:", url))
        message("Error:", e$message)
        return(FALSE)
    })
}

# Test case
test_url1 <- "https://raw.githubusercontent.com/mkim0710/tidystat/master/rstudio-prefs/templates/default.R"
local_file1 <- "test_default.R"

safeDownloadFileIfDifferent(test_url1, local_file1)
safeDownloadFileIfDifferent(test_url1, local_file1)

```
  
  
###### \% |> safeDownloadFileWithConditionalGET() ----  
```{r, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="#", R.options=list(width=120)}
options(width=120)
library(httr)

# Function to download the file using conditional GET based on ETag
safeDownloadFileWithConditionalGET <- function(url, destfile) {
    # Check if the local file exists and has an associated ETag
    if (file.exists(destfile)) {
        etag_file <- paste0(destfile, ".etag")
        if (file.exists(etag_file)) {
            local_etag <- readLines(etag_file)
            response <- GET(url, add_headers(`If-None-Match` = local_etag))
        } else {
            response <- GET(url)
        }
    } else {
        response <- GET(url)
    }

    # If the status code is 304 (Not Modified), the file hasn't changed
    if (status_code(response) == 304) {
        message("No update needed for:", destfile)
        return(FALSE)
    } else if (status_code(response) == 200) {
        # Download the file if there is an update
        writeBin(content(response, "raw"), destfile)
        
        # Save the new ETag
        etag <- headers(response)$etag
        if (!is.null(etag)) {
            etag_file <- paste0(destfile, ".etag")
            writeLines(etag, etag_file)
        }
        message("Downloaded updated file: ", destfile)
        return(TRUE)
    } else {
        message("Unexpected status code: ", status_code(response))
        return(FALSE)
    }
}

# Test case
test_url1 <- "https://raw.githubusercontent.com/mkim0710/tidystat/master/rstudio-prefs/templates/default.R"
local_file1 <- "test_default.R"

safeDownloadFileWithConditionalGET(test_url1, local_file1)
safeDownloadFileWithConditionalGET(test_url1, local_file1)


```
  
  
###### \% |> calculateFileHash() ----  
```{r, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="#", R.options=list(width=120)}
options(width=120)
library(httr)
library(digest)

# Function to calculate the hash of a file using MD5 or SHA1
calculateFileHash <- function(filepath, algo = "md5") {
    tryCatch({
        return(digest(file(filepath, "rb"), algo = algo))
    }, error = function(e) {
        message("Error calculating hash: ", e$message)
        return(NULL)
    })
}

# Function to compare local and remote file hashes
safeDownloadFileIfDifferentByHash <- function(url, destfile, hash_algo = "md5") {
    tryCatch({
        # Check if the local file exists and calculate its hash
        if (file.exists(destfile)) {
            local_hash <- calculateFileHash(destfile, hash_algo)
            message("Local file hash: ", local_hash)
        } else {
            message("Local file does not exist.")
            local_hash <- NULL
        }
        
        # Download the remote file temporarily to calculate its hash
        response <- GET(url)
        if (status_code(response) == 200) {
            remote_content <- content(response, "raw")
            remote_tempfile <- tempfile()
            writeBin(remote_content, remote_tempfile)
            
            # Calculate hash of the downloaded remote file
            remote_hash <- calculateFileHash(remote_tempfile, hash_algo)
            message("Remote file hash: ", remote_hash)
            
            # Compare hashes
            if (!is.null(local_hash) && local_hash == remote_hash) {
                message("Local file is up-to-date with the remote file (Hash matches).")
                return(FALSE)  # No need to download, files are identical
            }
            
            # If hashes differ, replace the local file with the downloaded content
            writeBin(remote_content, destfile)
            message(paste("Downloaded and updated file:", destfile))
            return(TRUE)
        } else {
            message("Failed to download file. Status code: ", status_code(response))
            return(FALSE)
        }
    }, error = function(e) {
        message("Failed to download or update:", e$message)
        return(FALSE)
    })
}

# Test case
test_url1 <- "https://raw.githubusercontent.com/mkim0710/tidystat/master/rstudio-prefs/templates/default.R"
local_file1 <- "test_default.R"

safeDownloadFileIfDifferentByHash(test_url1, local_file1)
safeDownloadFileIfDifferentByHash(test_url1, local_file1)

```
  
  
#### switch(Sys.info()["sysname"], Linux = { ----  
```{r, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="#", R.options=list(width=120)}
options(width=120)
# > openxlsx2::xl_open
# function (x, interactive = NA) 
# {
#     UseMethod("xl_open")
# }
# <bytecode: 0x0000012b785dd928>
# <environment: namespace:openxlsx2>
# > getAnywhere(xl_open)
# A single .object matching â€˜xl_openâ€™ was found
# It was found in the following places
#   package:openxlsx2
#   namespace:openxlsx2
# with value
# 
# function (x, interactive = NA) 
# {
#     UseMethod("xl_open")
# }
# <bytecode: 0x0000012b785dd928>
# <environment: namespace:openxlsx2>
# > methods(xl_open)
# [1] xl_open.default*    xl_open.wbWorkbook*
# see '?methods' for accessing help and source code
# > openxlsx2:::xl_open.default
# function (x, interactive = NA) 
# {
#     stopifnot(file.exists(x))
#     if (is.na(interactive)) {
#         interactive <- interactive()
#     }
#     if (!isTRUE(interactive)) {
#         warning("will not open file when not interactive", call. = FALSE)
#         return()
#     }
#     file <- normalizePath(x, mustWork = TRUE)
#     userSystem <- Sys.info()["sysname"]
#     switch(userSystem, Linux = {
#         app <- getOption("openxlsx2.excelApp", chooseExcelApp())
#         system2(app, c(file, "&"))
#     }, Windows = {
#         shell.exec(file)
#     }, Darwin = {
#         system2("open", shQuote(file))
#     }, stop("Operating system not handled: ", toString(userSystem)))
# }
# <bytecode: 0x0000012b7a03a958>
# <environment: namespace:openxlsx2>


f_file.system_switch_open <- function(file) {
    stopifnot(file.exists(file))
    
    file <- normalizePath(file, mustWork = TRUE)
    
    switch(Sys.info()["sysname"], 
        Linux = {
            app <- Sys.getenv("BROWSER", "xdg-open")
            system2(app, file)
        }, 
        Windows = {
            shell.exec(file)
        }, 
        Darwin = {
            system2("open", shQuote(file))
        }, 
        stop("Operating system not handled: ", toString(userSystem))
    )
}

```
  
  
###### ECHO \% |> () ----  
```{r, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="#", R.options=list(width=120)}
options(width=120)

```
  
  
###### ECHO \% |> () ----  
```{r, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="#", R.options=list(width=120)}
options(width=120)

```
  
  
###### ECHO \% |> () ----  
```{r, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="#", R.options=list(width=120)}
options(width=120)

```
  
  
###### ECHO \% |> () ----  
```{r, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="#", R.options=list(width=120)}
options(width=120)

```
  
  
###### ECHO \% |> () ----  
```{r, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="#", R.options=list(width=120)}
options(width=120)

```
  
  
###### ECHO \% |> () ----  
```{r, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="#", R.options=list(width=120)}
options(width=120)

```
  
  
# __________|------  
# @@ END ----  
```{r END-NoEvalNoEchoNoMsgNoResults, eval=FALSE, echo=FALSE, warning=TRUE, message=NA, results="hide", collapse=TRUE, paged.print=FALSE}
##________________________________________________________________________________  
##%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
##++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++  
##~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~  
##________________________________________________________________________________  
##%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
# @@ END ----  
cat("    ::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::    \n")
cat("    [][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][][]    \n")
cat("    {}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}{}    \n")
cat("    ()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()()    \n")
cat("    <><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><><>    \n")
cat("    HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH    \n")
cat("    OOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOOO    \n")
cat("    XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX    \n")
cat("    VVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVVV    \n")
cat("    WWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWWW    \n")
cat("    -|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|-|    \n")
cat("    ________________________________________________________________________    \n")
cat("    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%    \n")
cat("    ************************************************************************    \n")
cat("    ++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++    \n")
cat("    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~    \n")
```
  
  
```{r MetaData99-NoEcho, eval=TRUE, echo=FALSE, warning=TRUE, message=TRUE, results="markdown", collapse=TRUE, paged.print=FALSE}
if(exists("MetaData")) {
    "MetaData |> str(max.level = 2, give.attr = FALSE)" |> env1$f$f_CodeText.echo(Execute = TRUE, deparse_cat = FALSE, LinePrefix4CodeText = "> ", LinePrefix4Output = "")
    cat("    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~    \n")
    # "MetaData$tblVarName |> str(max.level = 3, give.attr = FALSE)" |> env1$f$f_CodeText.echo(Execute = TRUE, deparse_cat = FALSE, LinePrefix4CodeText = "> ", LinePrefix4Output = "")
    # cat("    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~    \n")
    # "MetaData$DataSetNames |> str(max.level = 2, give.attr = FALSE)" |> env1$f$f_CodeText.echo(Execute = TRUE, deparse_cat = FALSE, LinePrefix4CodeText = "> ", LinePrefix4Output = "")
    # cat("    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~    \n")
    "MetaData$VarNames |> str(max.level = 3, give.attr = FALSE)" |> env1$f$f_CodeText.echo(Execute = TRUE, deparse_cat = FALSE, LinePrefix4CodeText = "> ", LinePrefix4Output = "")
    cat("    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~    \n")
    "MetaData$VarNames.select |> str(max.level = 3, give.attr = FALSE)" |> env1$f$f_CodeText.echo(Execute = TRUE, deparse_cat = FALSE, LinePrefix4CodeText = "> ", LinePrefix4Output = "")
    cat("    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~    \n")
    "MetaData$ModelList |> str(max.level = 3, give.attr = FALSE)" |> env1$f$f_CodeText.echo(Execute = TRUE, deparse_cat = FALSE, LinePrefix4CodeText = "> ", LinePrefix4Output = "")
    cat("    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~    \n")
    
    "all.equal(.MetaData0, MetaData)" |> env1$f$f_CodeText.echo(Execute = TRUE, deparse_cat = FALSE, LinePrefix4CodeText = "> ", LinePrefix4Output = "")
    if(!identical(.MetaData0, MetaData)) {
        cat("    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~    \n")
        .path_file = ifelse(is.null(env1$path$LastSourceEditorContext.path_filename.MetaData.rds), NULL, env1$path$LastSourceEditorContext.path_filename.MetaData.rds %>% {paste0(env1$path$path1,"/",.)})
        MetaData |> env1$f$f_objectname.size.write_rds.git_lfs_track_add_f(.path_file = .path_file, createBackup = TRUE, Execute = TRUE)
    }
} else {warning("> !exists(MetaData)  \n")}
```


```{r writeRDS-EvalNoEchoNoMsgNoResults, eval=TRUE, echo=FALSE, warning=TRUE, message=NA, results="hide"}
# __________|------  
## @ write_rds( get(.objectname), paste0(.path4write,ifelse(.path4write=="","","/"),.objectname,".rds",".xz"), compress = "xz", compression = 9L) |> system.time() |> round(3) |> unclass() |> deparse() |> cat("\n")
.path4write = .path4write %>% str_replace(fixed(env1$path$path1), "") %>% str_replace("^/", "")  # [][Rproject] makes an error in git bash
if(exists("MetaData")) {
    # MetaData$DataSetNames |> names() |> paste0(collapse = "\n") |> cat("\n", sep="")
    cat("    ________________________________________________________________________    \n")
    for (DataSetName in names(MetaData$DataSetNames)) {
        assign(DataSetName, structure(get(DataSetName), MetaData = as.environment(MetaData)), envir = .GlobalEnv)
        env1$f$f_objectname.size.write_rds.git_lfs_track_add_f(.objectname = DataSetName, .path4write = .path4write, createBackup = FALSE, Execute = FALSE, path.size_files = TRUE, git_lfs_track = TRUE, git_add_f = TRUE, CompressionMethod = "xz")
        cat("    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~    \n")
    }
}
# #++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# .path_filename.xlsx = paste0(.path4write,ifelse(.path4write=="","","/"),.objectname,".xlsx")
# openxlsx2::write_xlsx(get(.objectname), file = .path_filename.xlsx, as_table = TRUE) |> system.time() |> round(3) |> unclass() |> deparse() |> cat("\n") 
# if (Sys.info()["sysname"] == "Windows") openxlsx2::xl_open(.path_filename.xlsx)
# #++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# .path_filename.UTF8BOM.csv = paste0(.path4write,ifelse(.path4write=="","","/"),.objectname,".UTF8BOM.csv")
# if (Sys.info()["sysname"] == "Windows") {
#     readr::write_excel_csv(get(.objectname), file = .path_filename.UTF8BOM.csv) |> system.time() |> round(3) |> unclass() |> deparse() |> cat("\n")
#     openxlsx2::xl_open(.path_filename.xlsx)
# } else {
#     readr::write_excel_csv(get(.objectname), file = .path_filename.UTF8BOM.csv|>paste0(".xz")) |> system.time() |> round(3) |> unclass() |> deparse() |> cat("\n")
# }
# #++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++
# .path_filename.UTF8.csv.xz = paste0(.path4write,ifelse(.path4write=="","","/"),.objectname,".UTF8.csv.xz")
# readr::write_csv(get(.objectname), file = .path_filename.UTF8.csv.xz) |> system.time() |> round(3) |> unclass() |> deparse() |> cat("\n")
```
  
  
```{r createBackup, eval=TRUE, include=FALSE}
if (Sys.getenv("PARENT_RENDERING") != "YES") {
    # if (Sys.info()["sysname"] == "Windows") {
        env1$env.internal.attach$f_filename.ext.createBackup(backup_from_path_filename.ext = rstudioapi::getSourceEditorContext()$path|>str_replace("\\.([[:alnum:]]+)$",".Rmd"), .backup_to_path="-backup", timeFormat="%y%m%d_%H", overwrite=TRUE)
        # env1$env.internal.attach$f_filename.ext.createBackup(backup_from_path_filename.ext = rstudioapi::getSourceEditorContext()$path|>str_replace("\\.([[:alnum:]]+)$",".nb.html"), .backup_to_path="-backup", timeFormat="%y%m%d_%H", overwrite=TRUE)
    # }
}
```
  
  
```{r Render-NoEchoNoMsgNoResults, echo=FALSE, warning=TRUE, message=NA, results="hide"}
env1$path$LastSourceEditorContext.path_filename.pdf = env1$path$LastSourceEditorContext.path_filename.ext |> str_replace("\\.([[:alnum:]]+)$",".pdf") |> str_replace_all('[ <>()|\\:&;#?*\']', "-")
env1$path$LastSourceEditorContext.path_filename.html = env1$path$LastSourceEditorContext.path_filename.ext |> str_replace("\\.([[:alnum:]]+)$",".html") |> str_replace_all('[ <>()|\\:&;#?*\']', "-")
if (Sys.getenv("PARENT_RENDERING") != "YES") {
    if (Sys.info()["sysname"] == "Windows") {
        .tlmgr_installed_packages <- system2("tlmgr", args = c("info", "--list", "--only-installed"), stdout = TRUE)
        for (.font_name in c("roboto", "cascadia-code")) if(.tlmgr_installed_packages |> str_subset(.font_name) |> length() == 0) tinytex::tlmgr_install(.font_name)

        cat('Starting: rstudioapi::getSourceEditorContext()$path |> rmarkdown::render(output_dir = ',deparse(dirname(env1$path$LastSourceEditorContext.path_filename.ext)),', output_format = "pdf_document")  \n')
        Sys.setenv(PARENT_RENDERING = "YES"); env1$path$LastSourceEditorContext.path_filename.ext %>% {paste0(env1$path$path1,"/",.)} %>% {rmarkdown::render(input = .,output_dir = dirname(.), output_format = "pdf_document")}; Sys.setenv(PARENT_RENDERING = "NO")
        .path_file = env1$path$LastSourceEditorContext.path_filename.pdf %>% {paste0(env1$path$path1,"/",.)}
        env1$f$f_file.git_lfs_track_add_f(.path_file = .path_file, Execute = FALSE)
        env1$env.internal.attach$f_filename.ext.createBackup(backup_from_path_filename.ext = .path_file, .backup_to_path="-backup", timeFormat="%y%m%d_%H", overwrite=TRUE)
        try(env1$env.internal.attach$f_file_PDF.sumatra(.path_file))
    }
}
# env1$path$LastSourceEditorContext.path_filename.ext %>% {paste0(env1$path$path1,"/",.)} %>% {cat('  Sys.setenv(PARENT_RENDERING = "YES"); rmarkdown::render(input = ',deparse(.),', output_dir = ',deparse(dirname(.)),', output_format = "pdf_document"); Sys.setenv(PARENT_RENDERING = "NO")  \n', sep="")}; .path_file = env1$path$LastSourceEditorContext.path_filename.pdf %>% {paste0(env1$path$path1,"/",.)}; env1$f$f_file.git_lfs_track_add_f(.path_file = .path_file, Execute = FALSE); cat('  env1$env.internal.attach$f_filename.ext.createBackup(backup_from_path_filename.ext = ',deparse(.path_file),', .backup_to_path="-backup", timeFormat="%y%m%d_%H", overwrite=TRUE)  \n', sep=""); if (Sys.info()["sysname"] == "Windows") { cat('  env1$env.internal.attach$f_file_PDF.sumatra(',deparse(.path_file),')  \n', sep="") } else { cat('  browseURL(',deparse(.path_file),')  \n', sep="") }
# cat("    ________________________________________________________________________    \n")
env1$path$LastSourceEditorContext.path_filename.ext %>% {paste0(env1$path$path1,"/",.)} %>% {cat('  Sys.setenv(PARENT_RENDERING = "YES"); rmarkdown::render(input = ',deparse(.),', output_dir = ',deparse(dirname(.)),', output_format = "html_document"); Sys.setenv(PARENT_RENDERING = "NO")  \n', sep="")}; .path_file = env1$path$LastSourceEditorContext.path_filename.html %>% {paste0(env1$path$path1,"/",.)}; env1$f$f_file.git_lfs_track_add_f(.path_file = .path_file, Execute = FALSE); cat('  env1$env.internal.attach$f_filename.ext.createBackup(backup_from_path_filename.ext = ',deparse(.path_file),', .backup_to_path="-backup", timeFormat="%y%m%d_%H", overwrite=TRUE)  \n', sep=""); cat('  env1$env.internal.attach$f_URL.open_in_edge_app(',deparse(.path_file),')  \n', sep="")
```
  
  
```{r gitCheckout-NoEchoNoMsgNoResults, echo=FALSE, warning=TRUE, message=NA, results="hide"}
env1$source[[basename(rstudioapi::getSourceEditorContext()$path)]] = rstudioapi::getSourceEditorContext()$path
env1$path$LastSourceEditorContext.path_filename.nb.html = env1$path$LastSourceEditorContext.path_filename.ext |> str_replace("\\.([[:alnum:]]+)$",".nb.html")
if (Sys.info()["sysname"] == "Windows" && Sys.getenv("PARENT_RENDERING") != "YES") { paste0('ping -n 5 127.0.0.1 > nul & "C:/Program Files (x86)/Microsoft/Edge/Application/msedge_proxy.exe" --app="',env1$path$LastSourceEditorContext.path_filename.nb.html %>% {paste0(env1$path$path1,"/",.)}|>normalizePath(winslash="/"),'"') |> shell(wait=FALSE) } # else { browseURL(env1$path$LastSourceEditorContext.path_filename.nb.html %>% {paste0(env1$path$path1,"/",.)}) }
# paste0("https://github.com/mkim0710/",basename(getwd()),"/blob/main/",env1$path$LastSourceEditorContext.path_filename.ext) %>% paste0('"C:/Program Files (x86)/Microsoft/Edge/Application/msedge_proxy.exe" --app="',.,'"') |> system(intern=TRUE)
paste0("https://github.com/mkim0710/",basename(getwd()),"/blob/main/",env1$path$LastSourceEditorContext.path_filename.ext) %>% paste0('"C:/Program Files (x86)/Microsoft/Edge/Application/msedge_proxy.exe" --app="',.,'"') %>% paste0("'",.,"' |> system(intern=TRUE)") |> cat("  \n", sep="")
# paste0("https://github.com/mkim0710/",basename(getwd()),"/commits/main/",env1$path$LastSourceEditorContext.path_filename.ext) %>% paste0('"C:/Program Files (x86)/Microsoft/Edge/Application/msedge_proxy.exe" --app="',.,'"') |> system(intern=TRUE)
paste0("https://github.com/mkim0710/",basename(getwd()),"/commits/main/",env1$path$LastSourceEditorContext.path_filename.ext)  %>% paste0('"C:/Program Files (x86)/Microsoft/Edge/Application/msedge_proxy.exe" --app="',.,'"') %>% paste0("'",.,"' |> system(intern=TRUE)") |> cat("  \n", sep="")
cat("* To revert to the last commited file, run the following terminal command:  \n")
paste0( "git checkout -- ",shQuote(paste0(env1$path$path1,"/",env1$path$LastSourceEditorContext.path_filename.ext)) ) |> deparse() |> cat(" |> system(intern=TRUE)  \n", sep="")
paste0( "git checkout -- ",shQuote(paste0(env1$path$path1,"/",env1$path$LastSourceEditorContext.path_filename.nb.html)) ) |> deparse() |> cat(" |> system(intern=TRUE)  \n", sep="")
```
  
  
