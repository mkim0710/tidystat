---
title: "MHKim's R Notebook"
output: html_notebook
    df_print: tibble
---

# _______________
```{r Rstudio-RMarkDown-Shortcuts, eval=FALSE, include=FALSE}
# ##### Rstudio RMarkDown Shortcuts
# https://support.posit.co/hc/en-us/articles/200711853-Keyboard-Shortcuts-in-the-RStudio-IDE  
# https://bookdown.org/yihui/rmarkdown-cookbook/rstudio-shortcuts.html  
# Insert R chunk	Ctrl+Alt+I	Command+Option+I\
# Preview HTML	Ctrl+Shift+K	Command+Shift+K\
# Run all chunks above	Ctrl+Alt+P	Command+Option+P\
# Run current chunk	Ctrl+Alt+C	Command+Option+C\
# Run current chunk	Ctrl+Shift+Enter	Command+Shift+Enter\
# Run next chunk	Ctrl+Alt+N	Command+Option+N\
# Run all chunks	Ctrl+Alt+R	Command+Option+R\
# Go to next chunk/title	Ctrl+PgDown	Command+PgDown\
# Go to previous chunk/title	Ctrl+PgUp	Command+PgUp\
# Show/hide document outline	Ctrl+Shift+O	Command+Shift+O\
# F7 spell-check your document.\
# Restart the R session   Ctrl + Alt + F10 (or Command + Option + F10 on macOS).\
# \
# *** Caution: \% \$ \# \* \
```

```{r setup, eval=TRUE, include=FALSE}
# str(knitr::opts_chunk$get())
# cat(deparse(knitr::opts_chunk$get(), width.cutoff=120), "\n", sep="")
# list(eval=TRUE, echo=TRUE, results = "markup", tidy = FALSE, tidy.opts = NULL, collapse = FALSE, prompt = FALSE, comment = "##",     highlight = TRUE, size = "normalsize", background = "#F7F7F7", strip.white = structure(TRUE, class = "AsIs"), cache = FALSE,     cache.path = "cache/", cache.vars = NULL, cache.lazy = TRUE, dependson = NULL, autodep = FALSE, cache.rebuild = FALSE,     fig.keep = "high", fig.show = "asis", fig.align = "default", fig.path = "figure/", dev = NULL, dev.args = NULL, dpi = 72,     fig.ext = NULL, fig.width=7, fig.height=7, fig.env = "figure", fig.cap = NULL, fig.scap = NULL, fig.lp = "fig:",     fig.subcap = NULL, fig.pos = "", out.width=NULL, out.height=NULL, out.extra = NULL, fig.retina = 1, external = TRUE,     sanitize = FALSE, interval = 1, aniopts = "controls,loop", warning = TRUE, error = TRUE, message = TRUE, render = NULL,     ref.label = NULL, child = NULL, engine = "R", split = FALSE, include = TRUE, purl = TRUE)
knitr::opts_chunk$set(
  eval=TRUE, echo=TRUE, results="markup", collapse=TRUE, # In Rstudio Notebook Source Pane & nb.HTML, results="hold" does not work
  comment="", fig.width=10, fig.height=6, # In Rstudio Notebook Source Pane & nb.HTML, comment="##" does not work?
  warning=TRUE, message=TRUE, include=TRUE, 
    error=FALSE,  # error=TRUE: show the errors without stopping R; error=FALSE: stop on error
  tidy.opts=list(width.cutoff=120), tidy=TRUE, 
  R.options = list(width=120), paged.print=FALSE
) 
knitr::opts_knit$set(global.par = TRUE)
```


```{r options-width-NoEchoHideResults, echo=FALSE, results="hide"}
if(!exists("env1", envir=.GlobalEnv)) 
    assign("env1", new.env(), envir=.GlobalEnv)
if(!"info" %in% names(.GlobalEnv$env1)) .GlobalEnv$env1$info <- list()
env1$info$options.width = options()$width; cat(options()$width, "\n", sep="")
```


```{r loadPackages-NoEchoHideResults, echo=FALSE, results="hide"}
suppressPackageStartupMessages({for(packagename in c("tidyverse","formatR")) {if(!require(packagename,character.only=TRUE))install.packages(packagename) else library(packagename,character.only=TRUE)}});cat(" \n");
if(!exists("env1", envir=.GlobalEnv)) 
    assign("env1", new.env(), envir=.GlobalEnv)
## env1\$path ====
if(!"path" %in% names(.GlobalEnv$env1)) .GlobalEnv$env1$path <- list()
objectname = "source_base_local"; object = ifelse(.Platform$OS.type == "windows", "D:/OneDrive/[][Rproject]/github_tidystat", "~/github_tidystat"); if(!objectname %in% names(env1$path)) {env1$path[[objectname]] = object};
objectname = "source_base_github"; object = "https://github.com/mkim0710/tidystat/raw/master"; if(!objectname %in% names(env1$path)) {env1$path[[objectname]] = object};
env1$path$source_base = ifelse(dir.exists(env1$path$source_base_local), env1$path$source_base_local, env1$path$source_base_github)  
## env1\$env.internal ====
sourcename = "env1$env.internal"; subpath=""; subpath.filename.source.r = paste0(subpath,ifelse(subpath=="","","/"),sourcename,".source.r"); suppressPackageStartupMessages(source( file.path(env1$path$source_base,subpath.filename.source.r) ))
#### env1\$f_df.t.tribble_construct() ====
sourcename = "f_df.t.tribble_construct"; subpath=""; subpath.filename.source.r = paste0(subpath,ifelse(subpath=="","","/"),sourcename,".source.r"); suppressPackageStartupMessages(source( file.path(env1$path$source_base,subpath.filename.source.r) ))
```



<font size="3">\% env1</font>\

```{r envCustom-Info-NoEchoHideResults, echo=FALSE, results="hide"}
# https://yihui.org/knitr/options/#package-options
if(!exists("env1", envir=.GlobalEnv)) 
    assign("env1", new.env(), envir=.GlobalEnv)
if(!"info" %in% names(.GlobalEnv$env1)) .GlobalEnv$env1$info <- list()
#### env1\$info\$get_system_info() ====
sourcename = "get_system_info"; subpath=""; subpath.filename.source.r = paste0(subpath,ifelse(subpath=="","","/"),sourcename,".source.r"); suppressPackageStartupMessages(source( file.path(env1$path$source_base,subpath.filename.source.r) ))
env1$info$info_system_info = env1$info$get_system_info()
# str(env1$info$info_system_info)
CodeText = "env1$info$info_system_info$machine_nodename"; cat(CodeText, ' = "', eval(parse(text=CodeText)), '"', "\n", sep="")
CodeText = "env1$info$info_system_info$Sys.getlocale$LC_COLLATE"; cat(CodeText, ' = "', eval(parse(text=CodeText)), '"', "\n", sep="")
# CodeText = "env1$info$info_system_info$l10n_info$localization_UTF8"; cat(CodeText, ' = "', eval(parse(text=CodeText)), '"', "\n", sep="")
env1$info$info_software_versions = env1$info$get_software_versions(library_names = c("tidyverse", "dplyr", "ggplot2", "purrr", "stringr", "datapasta","openxlsx"))
# str(env1$info$info_software_versions)
```


###### env1\$info\$DocumentTitle1 ====
```{r envCustom-DocumentTitle1-NoEchoHideResults, echo=FALSE, results="hide"}
env1$info$DocumentTitle0 = paste0("00env1","-",basename(getwd()))
env1$info$DocumentTitle1 = paste0(env1$info$DocumentTitle0,"@", ifelse(grepl("MacBook-Pro", Sys.info()["nodename"]), "MBP", Sys.info()["nodename"]))
cat(env1$info$DocumentTitle0,"-",format(Sys.time(),"%y%m%d"), "\n", 
    env1$info$DocumentTitle0,"-",format(Sys.time(),"%y%m%d"),".Rmd", "\n", 
    env1$info$DocumentTitle0,"-dev",format(Sys.time(),"%y%m%d"),".Rmd", "\n", 
    env1$info$DocumentTitle0,"-clean",format(Sys.time(),"%y%m%d"),".Rmd", "\n", 
    sep="")
```


@ASROCKX300RYZEN
List of 9
 $ GUI             : chr "RStudio"
 $ os_type         : chr "windows"
 $ os_sysname      : chr "Windows"
 $ os_version      : chr "build 22621"
 $ machine_type    : chr "x86-64"
 $ machine_nodename: chr "ASROCKX300RYZEN"
 $ machine_cpu     : chr "AMD Ryzen 5 5600G with Radeon Graphics"
 $ Sys.getlocale   :List of 4
  ..$ LC_COLLATE       : chr "Korean_Korea.utf8"
  ..$ LC_CTYPE         : chr "Korean_Korea.utf8"
  ..$ LC_locale_NUMERIC: chr "C"
  ..$ LC_locale_TIME   : chr "Korean_Korea.utf8"
 $ l10n_info       :List of 5
  ..$ localization_UTF8           : logi TRUE
  ..$ localization_Latin1         : logi FALSE
  ..$ localization_codeset        : NULL
  ..$ localization_codepage       : int 65001
  ..$ localization_system.codepage: int 65001
  
  
@LIVAI7-8700
List of 9
 $ GUI             : chr "RStudio"
 $ os_type         : chr "windows"
 $ os_sysname      : chr "Windows"
 $ os_version      : chr "build 19045"
 $ machine_type    : chr "x86-64"
 $ machine_nodename: chr "LIVAI7-8700"
 $ machine_cpu     : chr "Intel(R) Core(TM) i7-8700 CPU @ 3.20GHz"
 $ Sys.getlocale   :List of 4
  ..$ LC_COLLATE       : chr "Korean_Korea.utf8"
  ..$ LC_CTYPE         : chr "Korean_Korea.utf8"
  ..$ LC_locale_NUMERIC: chr "C"
  ..$ LC_locale_TIME   : chr "Korean_Korea.utf8"
 $ l10n_info       :List of 5
  ..$ localization_UTF8           : logi TRUE
  ..$ localization_Latin1         : logi FALSE
  ..$ localization_codeset        : NULL
  ..$ localization_codepage       : int 65001
  ..$ localization_system.codepage: int 65001


@Posit Cloud
List of 9
 $ GUI             : chr "RStudio"
 $ os_type         : chr "unix"
 $ os_sysname      : chr "Linux"
 $ os_version      : chr "#96~18.04.1-Ubuntu SMP Mon Oct 17 02:57:48 UTC 2022"
 $ machine_type    : chr "x86_64"
 $ machine_nodename: chr "application-9677950-deployment-19172365-82455"
 $ machine_cpu     : chr "AMD EPYC 7R13 Processor"
 $ Sys.getlocale   :List of 4
  ..$ LC_COLLATE       : chr "C.UTF-8"
  ..$ LC_CTYPE         : chr "C.UTF-8"
  ..$ LC_locale_NUMERIC: chr "C"
  ..$ LC_locale_TIME   : chr "C.UTF-8"
 $ l10n_info       :List of 5
  ..$ localization_UTF8           : logi TRUE
  ..$ localization_Latin1         : logi FALSE
  ..$ localization_codeset        : chr "UTF-8"
  ..$ localization_codepage       : NULL
  ..$ localization_system.codepage: NULL
  



###### env1\$path ====
```{r envCustom-Path-NoEcho, echo=FALSE, results="markup", collapse=TRUE, paged.print=FALSE}
library(tidyverse);cat(" \n"); 
cat(" \n"); cat(" getwd() == "); dput(getwd()) #----
env1$path$getwd = getwd()
# env1$path$path0 = file.path("D:", "OneDrive - SNU", "[][Rproject]")
# env1$path$project_base = "Rproject_HEALS0215"
# env1$path$data_suffix = "_01"
# # env1$path$data_suffix = ""
# env1$path$project_suffix = "GJ3"
# 
#|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|#  
# env1$path$path4read = file.path(env1$path$path0, paste0(env1$path$project_base, env1$path$data_suffix))
# env1$path$path4write = file.path(env1$path$path4read, paste0(env1$path$project_base, env1$path$data_suffix, env1$path$project_suffix))
cat(" > str(env1$path)\n"); str(env1$path, max.level = 1, give.attr = F)  
# 
# path4read  = env1$path$path4read
# # path4write = env1$path$path4read
# # path4write = env1$path$path4write
path4read = getwd()
path4write = getwd()
sourcename = "f_objectname.read.checkEntity"; subpath=""; subpath.filename.source.r = paste0(subpath,ifelse(subpath=="","","/"),sourcename,".source.r"); suppressPackageStartupMessages(source( file.path(env1$path$source_base,subpath.filename.source.r) ))
if (getwd() != path4write) warning("getwd() != path4write  == ") else cat(" getwd() == path4write == "); dput(path4write)  #----
```


##% env1$f_path.size_files() ====
```{r, results="markup", collapse=TRUE, paged.print=FALSE, comment="", R.options=list(width=120)}
options(width=120)
# tribble_paste = datapasta::tribble_paste
# https://github.com/mkim0710/tidystat/blob/master/f_df.t.tribble_construct.dev.r
load(url("https://github.com/mkim0710/tidystat/raw/master/f_df.t.tribble_construct.RData"))
# attach(env1)

# regex4filename = "\\.rds(\\.xz)?$"
regex4filename = "\\.rds\\.xz$"
list.files(path4write) %>% grep(regex4filename, ., value = T) %>% {cat(" ----\n", deparse(., width.cutoff=120), "\n\n", sep="")} # dput() cat(deparse(., width.cutoff=120)), width.cutoff=500 is the max ----
env1$f_path.size_files(path4read = path4write, regex4filename = regex4filename)

cat(strrep("~",80),"\n",sep=""); #----
regex4filename = "\\.rds$"
list.files(path4write) %>% grep(regex4filename, ., value = T) %>% {cat(" ----\n", deparse(., width.cutoff=120), "\n\n", sep="")} # dput() cat(deparse(., width.cutoff=120)), width.cutoff=500 is the max ----
env1$f_path.size_files(path4read = path4write, regex4filename = regex4filename)
```


# @@ START) Baseline ------
## \$ objectname = "as1.na.Date.fct.select89" ====
@ assign(objectname, read_rds(file.path(path4read, paste0(objectname,".rds")))) 
```{r objectname-read.checkEntity, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="", R.options=list(width=120)}
options(width=120)
sourcename = "f_objectname.read.checkEntity"; subpath=""; subpath.filename.source.r = paste0(subpath,ifelse(subpath=="","","/"),sourcename,".source.r"); suppressPackageStartupMessages(source( file.path(env1$path$source_base,subpath.filename.source.r) ))
objectname = "as1.na.Date.fct.select89"; cat(" ----\n> ", 'objectname = "', objectname, '"\n', sep=""); 
filename2read = if(file.exists(file.path(path4read, paste0(objectname,".rds")))) paste0(objectname,".rds") else paste0(objectname, ".rds.xz")
env1$f_path.size_files(path4read = path4read, regex4filename = filename2read)
system.time(assign(objectname, readRDS(file.path(path4read, filename2read)), envir=.GlobalEnv))
cat(" dim(",objectname,") = ",deparse(dim(get(objectname))),"\n", sep="")

get(objectname) %>% {.$PERSON_ID} |> n_distinct()
get(objectname) %>% {.$RN_INDI} |> n_distinct()
get(objectname) |> names() %>% {cat(" ----\n", deparse(., width.cutoff=120), "\n\n", sep="")} # dput() cat(deparse(., width.cutoff=120)), width.cutoff=500 is the max ----
get(objectname) |> names() %>% paste(collapse=", ") %>% {cat(" ----\n", ., "\n\n", sep="")}; # tidyselect: paste(collapse=", ") |> cat() ----
cat(" ----\n> ", "str(get(objectname), max.level = 2, give.attr = F)", "\n", sep=""); str(get(objectname), max.level = 2, give.attr = F); 
# get(objectname) |> select_if(is.numeric) |> summary() #-----
# get(objectname) |> select_if(is.logical) |> summary() #-----
```


# @@ START) Outcome ------
## \$ objectname = "as1_7.na.Date.fct.cumulative_DM.list" ====
@ assign(objectname, read_rds(file.path(path4read, paste0(objectname,".rds")))) 
```{r objectname-read.checkEntity, echo=TRUE, results="markup", collapse=TRUE, paged.print=FALSE, comment="", R.options=list(width=120)}
options(width=120)
sourcename = "f_objectname.read.checkEntity"; subpath=""; subpath.filename.source.r = paste0(subpath,ifelse(subpath=="","","/"),sourcename,".source.r"); suppressPackageStartupMessages(source( file.path(env1$path$source_base,subpath.filename.source.r) ))
objectname = "as1_7.na.Date.fct.cumulative_DM.list"; cat(" ----\n> ", 'objectname = "', objectname, '"\n', sep=""); 
filename2read = if(file.exists(file.path(path4read, paste0(objectname,".rds")))) paste0(objectname,".rds") else paste0(objectname, ".rds.xz")
env1$f_path.size_files(path4read = path4read, regex4filename = filename2read)
system.time(assign(objectname, readRDS(file.path(path4read, filename2read)), envir=.GlobalEnv))
cat(" dim(",objectname,") = ",deparse(dim(get(objectname))),"\n", sep="")

get(objectname) %>% {.$PERSON_ID} |> n_distinct()
get(objectname) %>% {.$RN_INDI} |> n_distinct()
get(objectname) |> names() %>% {cat(" ----\n", deparse(., width.cutoff=120), "\n\n", sep="")} # dput() cat(deparse(., width.cutoff=120)), width.cutoff=500 is the max ----
get(objectname) |> names() %>% paste(collapse=", ") %>% {cat(" ----\n", ., "\n\n", sep="")}; # tidyselect: paste(collapse=", ") |> cat() ----
cat(" ----\n> ", "str(get(objectname), max.level = 2, give.attr = F)", "\n", sep=""); str(get(objectname), max.level = 2, give.attr = F); 
# get(objectname) |> select_if(is.numeric) |> summary() #-----
# get(objectname) |> select_if(is.logical) |> summary() #-----
```



##% as1_7.na.Date.fct.cumulative_DM.list |> str(max.level = 2)
```{r, paged.print=FALSE, fig.width=8, fig.height=6}
as1_7.na.Date.fct.cumulative_DM.list |> str(max.level = 2)
```





# \$ as1_7.na.Date.fct.cumulative_DM.list$Time2Event_NewDMv3 -----
```{r, results="markup", collapse=TRUE, paged.print=FALSE, comment="", R.options=list(width=120)}
options(width=120)
# as1_7.na.Date.fct.cumulative_DM.list$Time2Event_NewDMv3 =
#     as1_7.na.Date.fct.cumulative_DM.list$NewDMv3_atWavei %>% 
#     transmute(Time2Event_NewDMv3 = case_when(
#         NewDMv3_atWave1 == TRUE ~ 1,
#         NewDMv3_atWave2 == TRUE ~ 2,
#         NewDMv3_atWave3 == TRUE ~ 3,
#         NewDMv3_atWave4 == TRUE ~ 4,
#         NewDMv3_atWave5 == TRUE ~ 5,
#         NewDMv3_atWave6 == TRUE ~ 6,
#         NewDMv3_atWave7 == TRUE ~ 7,
#         TRUE ~ NA_real_
#     )) %>% 
#     mutate(
#         Event_NewDMv3 = !is.na(Time2Event_NewDMv3)
#     )
as1_7.na.Date.fct.cumulative_DM.list$Time2Event_NewDMv3 %>% {cat(" > ",deparse(substitute(.))," |> str()","\n", sep=""); str(.)}
as1_7.na.Date.fct.cumulative_DM.list$Time2Event_NewDMv3 |> summary()
as1_7.na.Date.fct.cumulative_DM.list$Time2Event_NewDMv3 |> table(useNA="always") |> addmargins
# > as1_7.na.Date.fct.cumulative_DM.list$Time2Event_NewDMv3 %>% {cat(" > ",deparse(substitute(.))," |> str()","\n", sep=""); str(.)}
# tibble [10,030 × 2] (S3: tbl_df/tbl/data.frame)
#  $ Time2Event_NewDMv3: num [1:10030] NA NA NA 1 NA NA NA NA 1 NA ...
#  $ Event_NewDMv3     : logi [1:10030] FALSE FALSE FALSE TRUE FALSE FALSE ...
# > as1_7.na.Date.fct.cumulative_DM.list$Time2Event_NewDMv3 |> summary()
#  Time2Event_NewDMv3 Event_NewDMv3  
#  Min.   :1.000      Mode :logical  
#  1st Qu.:1.000      FALSE:7946     
#  Median :1.000      TRUE :2084     
#  Mean   :2.517                     
#  3rd Qu.:4.000                     
#  Max.   :7.000                     
#  NA's   :7946                      
# > as1_7.na.Date.fct.cumulative_DM.list$Time2Event_NewDMv3 |> table(useNA="always") |> addmargins
#                   Event_NewDMv3
# Time2Event_NewDMv3 FALSE  TRUE  <NA>   Sum
#               1        0  1185     0  1185
#               2        0   138     0   138
#               3        0   154     0   154
#               4        0   136     0   136
#               5        0   186     0   186
#               6        0   146     0   146
#               7        0   139     0   139
#               <NA>  7946     0     0  7946
#               Sum   7946  2084     0 10030
```



# \$ as1_7.na.Date.fct.cumulative_DM.list$Time2Censor_NewDMv3 -----
```{r, results="markup", collapse=TRUE, paged.print=FALSE, comment="", R.options=list(width=120)}
options(width=120)
# as1_7.na.Date.fct.cumulative_DM.list$Time2Censor_NewDMv3 =
#     as1_7.na.Date.fct.cumulative_DM.list$NewDMv3_atWavei %>% 
#     transmute(Time2Event_NewDMv3 = case_when(
#         NewDMv3_atWave1 == TRUE ~ 1,
#         NewDMv3_atWave2 == TRUE ~ 2,
#         NewDMv3_atWave3 == TRUE ~ 3,
#         NewDMv3_atWave4 == TRUE ~ 4,
#         NewDMv3_atWave5 == TRUE ~ 5,
#         NewDMv3_atWave6 == TRUE ~ 6,
#         NewDMv3_atWave7 == TRUE ~ 7,
#         TRUE ~ NA_real_
#     )) %>% 
#     transmute(
#         Event_NewDMv3 = !is.na(Time2Event_NewDMv3)
#         , Time2Censor_NewDMv3 = replace_na(Time2Event_NewDMv3, 7)
#     )
as1_7.na.Date.fct.cumulative_DM.list$Time2Censor_NewDMv3 %>% {cat(" > ",deparse(substitute(.))," |> str()","\n", sep=""); str(.)}
as1_7.na.Date.fct.cumulative_DM.list$Time2Censor_NewDMv3 |> summary()
as1_7.na.Date.fct.cumulative_DM.list$Time2Censor_NewDMv3 |> table(useNA="always") |> addmargins
```



# \$ df_NewDMv3.NAtime =====
```{r, paged.print=FALSE, fig.width=8, fig.height=6}
df_NewDMv3.NAtime = as1_7.na.Date.fct.cumulative_DM.list$Time2Event_NewDMv3 |> 
    rename(event = Event_NewDMv3, time = Time2Event_NewDMv3) |> 
    mutate(StudyPopulation = !event | time > 1) |> 
    mutate(Group = StudyPopulation |> as.integer()) |> 
    as_tibble()
df_NewDMv3.NAtime
df_NewDMv3.NAtime |> dplyr::select(time, event, Group, StudyPopulation) %>% by(.$StudyPopulation, summary)
# > df_NewDMv3.NAtime
# # A tibble: 10,030 × 4
#     time event StudyPopulation Group
#    <dbl> <lgl> <lgl>           <int>
#  1    NA FALSE TRUE                1
#  2    NA FALSE TRUE                1
#  3    NA FALSE TRUE                1
#  4     1 TRUE  FALSE               0
#  5    NA FALSE TRUE                1
#  6    NA FALSE TRUE                1
#  7    NA FALSE TRUE                1
#  8    NA FALSE TRUE                1
#  9     1 TRUE  FALSE               0
# 10    NA FALSE TRUE                1
# # ℹ 10,020 more rows
# # ℹ Use `print(n = ...)` to see more rows
# > df_NewDMv3.NAtime |> dplyr::select(time, event, Group, StudyPopulation) %>% by(.$StudyPopulation, summary)
# .$StudyPopulation: FALSE
#       time    event             Group   StudyPopulation
#  Min.   :1   Mode:logical   Min.   :0   Mode :logical  
#  1st Qu.:1   TRUE:1185      1st Qu.:0   FALSE:1185     
#  Median :1                  Median :0                  
#  Mean   :1                  Mean   :0                  
#  3rd Qu.:1                  3rd Qu.:0                  
#  Max.   :1                  Max.   :0                  
# ------------------------------------------------------------------------------------------ 
# .$StudyPopulation: TRUE
#       time         event             Group   StudyPopulation
#  Min.   :2.000   Mode :logical   Min.   :1   Mode:logical   
#  1st Qu.:3.000   FALSE:7946      1st Qu.:1   TRUE:8845      
#  Median :5.000   TRUE :899       Median :1                  
#  Mean   :4.517                   Mean   :1                  
#  3rd Qu.:6.000                   3rd Qu.:1                  
#  Max.   :7.000                   Max.   :1                  
#  NA's   :7946                                                                              
```



# \$ df_NewDMv3.CensorEND # @@ START) Analysis ------

## \$ DataSetName = "analyticDF_time2event" ====
#### [Plot] Stratified Kaplan-Meier Survival Curve
```{r plot-CodeTemplate, eval=FALSE, include=FALSE}
# {r plotWidth10Height6, results="markup", collapse=TRUE, paged.print=FALSE, fig.width=10, fig.height=6}
options(width=120)
suppressPackageStartupMessages(library(tidyverse))
# suppressPackageStartupMessages(library(survival))
# suppressPackageStartupMessages(library(survminer))

?survminer::ggsurvplot  # "event" plots cumulative events (f(y) = 1-y), "cumhaz" plots the cumulative hazard function (f(y) = -log(y)), and "pct" for survival probability in percentage.
# df_NewDMv3.NAtime.survfit |> ggsurvplot(fun = "pct")  # default fun = "pct"?
# df_NewDMv3.NAtime.survfit |> ggsurvplot(fun = "event")
# df_NewDMv3.NAtime.survfit |> ggsurvplot(fun = "cumhaz")  # Cumulative Hazard = -log S(t)
value_for_Censor_at_END = 7
value_for_break.time.by = 1
time_scale = "wave"
varname4Group = "Group"
df_NewDMv3.CensorEND = df_NewDMv3.NAtime |> 
    mutate(
        time = time |> replace_na(Inf)
        # , event = event |> replace_na(F)
    ) |> 
    # mutate(event.CensorEND = ifelse(time <= value_for_Censor_at_END, event, F)) |> 
    # mutate(time.CensorEND = pmin(time, value_for_Censor_at_END)) |> 
    mutate(event = ifelse(time <= value_for_Censor_at_END, event, F)) |> 
    mutate(time = pmin(time, value_for_Censor_at_END)) |> 
    as_tibble()
survminer::ggsurvplot(survival::survfit(survival::Surv(time = time, event = event) ~ Group, data = df_NewDMv3.CensorEND |> filter(StudyPopulation)), palette = c("#00AFBB", "#FC4E07")
           , break.time.by = value_for_break.time.by
           , conf.int = TRUE, risk.table = TRUE, pval = TRUE
           , xlim = c(1, value_for_Censor_at_END), ylim = c(0, 1)
           , title = paste0("Survival Curves Stratified by ", varname4Group)
           , xlab = paste0("Time scale: ", time_scale), ylab = "Survival Probability")

```


#! Double-Check the event & time

# \$ df_NewDMv3.Time2Censor_NewDMv3 ====
```{r, results="markup", collapse=TRUE, paged.print=FALSE, comment="", R.options=list(width=120)}
options(width=120)
df_NewDMv3.Time2Censor_NewDMv3 = as1_7.na.Date.fct.cumulative_DM.list$Time2Censor_NewDMv3 |> 
    rename(event = Event_NewDMv3, time = Time2Censor_NewDMv3) |> 
    mutate(StudyPopulation = !event | time > 1) |> 
    mutate(Group = StudyPopulation |> as.integer()) |> 
    as_tibble()
df_NewDMv3.Time2Censor_NewDMv3
df_NewDMv3.Time2Censor_NewDMv3 %>% {cat(" > ",deparse(substitute(.))," |> str()","\n", sep=""); str(.)}
df_NewDMv3.Time2Censor_NewDMv3 |> dplyr::select(time, event, Group, StudyPopulation) %>% by(.$StudyPopulation, summary)
df_NewDMv3.CensorEND %>% {cat(" > ",deparse(substitute(.))," |> str()","\n", sep=""); str(.)}
df_NewDMv3.CensorEND |> dplyr::select(time, event, Group, StudyPopulation) %>% by(.$StudyPopulation, summary)
all.equal(df_NewDMv3.Time2Censor_NewDMv3 |> dplyr::select(time, event), df_NewDMv3.CensorEND |> dplyr::select(time, event))
table(df_NewDMv3.Time2Censor_NewDMv3$event, df_NewDMv3.CensorEND$event, useNA = "always") %>% addmargins
```


```{r, results="markup", collapse=TRUE, paged.print=FALSE, comment="", R.options=list(width=120)}
options(width=120)

```


```{r, results="markup", collapse=TRUE, paged.print=FALSE, comment="", R.options=list(width=120)}
options(width=120)

```


```{r, results="markup", collapse=TRUE, paged.print=FALSE, comment="", R.options=list(width=120)}
options(width=120)

```


```{r, results="markup", collapse=TRUE, paged.print=FALSE, comment="", R.options=list(width=120)}
options(width=120)

```

# @@ START) Analysis ------

## \$ DataSetName = "analyticDF_time2event" ====
#### [Plot] Stratified Kaplan-Meier Survival Curve
```{r plot-CodeTemplate, eval=FALSE, include=FALSE}
# {r plotWidth10Height6, results="markup", collapse=TRUE, paged.print=FALSE, fig.width=10, fig.height=6}
# library(tidyverse)
# # library(survival)
# # library(survminer)
# ?survival::lung
# df_time2event = survival::lung |> mutate(event = as.logical(status-1), Group = c("Male", "Female")[sex] |> as.factor(), StudyPopulation = time >= 30) %>% {cat(" > ",deparse(substitute(.))," |> as_tibble() |> print(n=99)","\n", sep=""); print(as_tibble(.),n=99)}
# # df_time2event |> dplyr::select(sex, Group) %>% {cat(" > ",deparse(substitute(.))," |> str()","\n", sep=""); str(.)}
# # df_time2event |> dplyr::select(sex, Group) |> table(useNA="always") |> addmargins
# # # > df_time2event |> dplyr::select(sex, Group) %>% {cat(" > ",deparse(substitute(.))," |> str()","\n", sep=""); str(.)}
# # # 'data.frame':	228 obs. of  2 variables:
# # #  $ sex  : num  1 1 1 1 1 1 2 2 1 1 ...
# # #  $ Group: Factor w/ 2 levels "Female","Male": 2 2 2 2 2 2 1 1 2 2 ...
# # # > df_time2event |> dplyr::select(sex, Group) |> table(useNA="always") |> addmargins
# # #    Group
# # # sex Female Male
# # #   1      0  138
# # #   2     90    0
# df_time2event |> dplyr::select(time, event, Group, StudyPopulation) %>% by(.$StudyPopulation, summary)
# # > df_time2event |> dplyr::select(time, event, Group, StudyPopulation) %>% by(.$StudyPopulation, summary)
# # .$StudyPopulation: FALSE
# #       time     event            Group   StudyPopulation
# #  Min.   : 5   Mode:logical   Female:1   Mode :logical  
# #  1st Qu.:11   TRUE:9         Male  :8   FALSE:9        
# #  Median :12                                            
# #  Mean   :13                                            
# #  3rd Qu.:13                                            
# #  Max.   :26                                            
# # ------------------------------------------------------------------------------------------ 
# # .$StudyPopulation: TRUE
# #       time          event            Group     StudyPopulation
# #  Min.   :  30.0   Mode :logical   Female: 89   Mode:logical   
# #  1st Qu.: 176.5   FALSE:63        Male  :130   TRUE:219       
# #  Median : 269.0   TRUE :156                                   
# #  Mean   : 317.2                                               
# #  3rd Qu.: 419.5                                               
# #  Max.   :1022.0   
# 
# ?survminer::ggsurvplot  # "event" plots cumulative events (f(y) = 1-y), "cumhaz" plots the cumulative hazard function (f(y) = -log(y)), and "pct" for survival probability in percentage.
# # df_time2event.survfit |> ggsurvplot(fun = "pct")  # default fun = "pct"?
# # df_time2event.survfit |> ggsurvplot(fun = "event")
# # df_time2event.survfit |> ggsurvplot(fun = "cumhaz")  # Cumulative Hazard = -log S(t)
# value_for_Censor_at_END = 365 * 1
# value_for_break.time.by = 30
# time_scale = "days"
# varname4Group = "Group"
# df_time2event.CensorEND = df_time2event %>%
#     mutate(
#         time = time |> replace_na(Inf)
#         # , event = event |> replace_na(F)
#     ) %>%
#     # mutate(event.CensorEND = ifelse(time <= value_for_Censor_at_END, event, F)) %>%
#     # mutate(time.CensorEND = pmin(time, value_for_Censor_at_END)) %>%
#     mutate(event = ifelse(time <= value_for_Censor_at_END, event, F)) %>%
#     mutate(time = pmin(time, value_for_Censor_at_END)) %>%
#     as_tibble()
# df_time2event.CensorEND |> dplyr::select(time, event, Group, StudyPopulation) %>% by(.$StudyPopulation, summary)
# # > df_time2event.CensorEND |> dplyr::select(time, event, Group, StudyPopulation) %>% by(.$StudyPopulation, summary)
# # .$StudyPopulation: FALSE
# #       time     event            Group   StudyPopulation
# #  Min.   : 5   Mode:logical   Female:1   Mode :logical  
# #  1st Qu.:11   TRUE:9         Male  :8   FALSE:9        
# #  Median :12                                            
# #  Mean   :13                                            
# #  3rd Qu.:13                                            
# #  Max.   :26                                            
# # ------------------------------------------------------------------------------------------ 
# # .$StudyPopulation: TRUE
# #       time         event            Group     StudyPopulation
# #  Min.   : 30.0   Mode :logical   Female: 89   Mode:logical   
# #  1st Qu.:176.5   FALSE:107       Male  :130   TRUE:219       
# #  Median :269.0   TRUE :112                                   
# #  Mean   :253.6                                               
# #  3rd Qu.:365.0                                               
# #  Max.   :365.0                                               
# survminer::ggsurvplot(survival::survfit(survival::Surv(time = time, event = event) ~ Group, data = df_time2event.CensorEND |> filter(StudyPopulation)), palette = c("#00AFBB", "#FC4E07")
#            , break.time.by = value_for_break.time.by
#            , conf.int = TRUE, risk.table = TRUE, pval = TRUE
#            , xlim = c(0, value_for_Censor_at_END), ylim = c(0, 1)
#            , title = paste0("Survival Curves Stratified by ", varname4Group)
#            , xlab = paste0("Time in ", time_scale), ylab = "Survival Probability")

```


# @@ END ------------
```{r END-NoEvalNoEchoNoMsgNoResults, eval=FALSE, echo=FALSE, warning=TRUE, message=NA, results="hide", collapse=TRUE, paged.print=FALSE}
#|________________________________________________________________________________|#  
#|%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%|#  
#|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|#  
#|++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++|#  
#|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|#  
#|________________________________________________________________________________|#  
#|%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%|#  
# @@ END ------------
```


```{r createBackup, eval=TRUE, include=FALSE}
env1$env.internal$f_filename.ext.createBackup(backup_from_path.filename.ext = rstudioapi::getSourceEditorContext()$path|>str_replace("\\.([[:alnum:]]+)$",".Rmd"), backup_to_path="-backup", timeFormat="%y%m%d_%H", overwrite=TRUE)
# env1$env.internal$f_filename.ext.createBackup(backup_from_path.filename.ext = rstudioapi::getSourceEditorContext()$path|>str_replace("\\.([[:alnum:]]+)$",".nb.html"), backup_to_path="-backup", timeFormat="%y%m%d_%H", overwrite=TRUE)
```


```{r Render, eval=TRUE, include=FALSE}
# if (Sys.getenv("PARENT_RENDERING") != "YES") {
#     cat('Starting: rstudioapi::getSourceEditorContext()$path |> rmarkdown::render(output_format = "pdf_document") \n')
#     Sys.setenv(PARENT_RENDERING = "YES"); rstudioapi::getSourceEditorContext()$path |> rmarkdown::render(output_format = "pdf_document"); Sys.setenv(PARENT_RENDERING = "NO")
#     env1$env.internal$f_filename.ext.createBackup(backup_from_path.filename.ext = rstudioapi::getSourceEditorContext()$path|>str_replace("\\.([[:alnum:]]+)$",".pdf"), backup_to_path="-backup", timeFormat="%y%m%d_%H", overwrite=TRUE)
#     env1$env.internal$f_file_PDF.sumatra(rstudioapi::getSourceEditorContext()$path|>str_replace("\\.([[:alnum:]]+)$",".pdf"))
# }
cat(' Sys.setenv(PARENT_RENDERING = "YES"); "',rstudioapi::getSourceEditorContext()$path,'" |> rmarkdown::render(output_format = "pdf_document"); Sys.setenv(PARENT_RENDERING = "NO")',"\n", 
    ' env1$env.internal$f_filename.ext.createBackup(backup_from_path.filename.ext = "',rstudioapi::getSourceEditorContext()$path|>str_replace("\\.([[:alnum:]]+)$",".pdf"),'", backup_to_path="-backup", timeFormat="%y%m%d", overwrite=TRUE)',"\n", 
    ' env1$env.internal$f_file_PDF.sumatra("',rstudioapi::getSourceEditorContext()$path|>str_replace("\\.([[:alnum:]]+)$",".pdf"),'")',"\n", sep="")
```


```{r gitCheckout, eval=TRUE, include=FALSE}
cat(" * To revert to the last commited file, run the following terminal command:\n", 
    '"git checkout -- ',rstudioapi::getSourceEditorContext()$path,'" |> system(intern=TRUE)',"\n",
    '"git checkout -- ',rstudioapi::getSourceEditorContext()$path|>str_replace("\\.([[:alnum:]]+)$",".nb.html"),'" |> system(intern=TRUE)',"\n", sep="")
```


## \$ objectname = "df_NewDMv3.NAtime200621" ====
###### @ write_rds( get(objectname), file.path(path4write, paste0(objectname,".rds"))) -----
```{r writeRDS-NoEvalNoEchoNoMsgNoResults, eval=FALSE, echo=FALSE, warning=TRUE, message=NA, results="hide", collapse=TRUE, paged.print=FALSE}
# 
# @ write_rds( get(objectname), file.path(path4write, paste0(objectname,".rds"))) -----
# objectname = "df_NewDMv3.NAtime200621"
# system.time(write_rds( get(objectname),paste0(objectname,".rds")))
# # system.time(write_rds( get(objectname), file.path(path4write, paste0(objectname,".rds"))))
# # system.time(write_rds( get(objectname), file.path(path4write, paste0(objectname,".rds")), compress = "gz" ))
# # system.time(write_rds( get(objectname), file.path(path4write, paste0(objectname, ".rds", "")), compress = "xz", compression = 9 ))
# # system.time(openxlsx::write.xlsx(get(objectname), file=paste0(objectname,".xlsx"), asTable=TRUE, withFilter=TRUE))
# # if (.Platform$OS.type == "windows") openxlsx::openXL(paste0(objectname, ".xlsx"))
```


