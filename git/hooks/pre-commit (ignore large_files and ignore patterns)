#!/bin/sh
# https://chatgpt.com/c/18230911-9003-42ad-9e3f-071c3310a148
#|________________________________________________________________________________|#  
#|%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%|#  
#|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|#  
#|++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++|#  
#|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|#  
#|________________________________________________________________________________|#  
#|%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%|#  
# Maximum file size in bytes (10MB)
MAX_SIZE=$((10 * 1024 * 1024))

# List of file patterns to ignore (add your patterns here)
patterns="*.rda *.rda.* *.rds *.rds.* *.RData *.RData.* *.csv *.csv.* *.xls *.xls.* *.xlsx *.xlsx.*"
#|________________________________________________________________________________|#  
#|%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%|#  
# Function to get file size
get_file_size() {
    filename="$1"
    if command -v stat > /dev/null 2>&1; then
        stat -c%s "$filename" 2>/dev/null  # stat is faster than wc, but may not be available on all systems
    else
        wc -c <"$filename" 2>/dev/null
    fi
}
#|________________________________________________________________________________|#  
#|%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%|#  
# # Initialize variables to store ignored files
# ignored_files_due_to_size=""
# ignored_files_due_to_pattern=""

# Initialize arrays to store ignored files
ignored_files_due_to_size=()
ignored_files_due_to_pattern=()

# Temporary files to store output from the while loop
tmp_size=$(mktemp)
tmp_pattern=$(mktemp)
#|%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%|#  
# Find files matching the patterns or exceeding the size limit
git diff --cached --name-only | while read -r filename; do
    # read -r: The read command treats backslashes as literal characters, preventing them from being interpreted as escape sequences. This is generally the desired behavior when reading filenames.
    if [ -f "$filename" ]; then
        # filesize=$(wc -c <"$filename")  # stat is faster than wc, but may not be available on all systems
        # filesize=$(stat -c%s "$filename")  # stat is faster than wc, but may not be available on all systems
        filesize=$(get_file_size "$filename")
        if [ "$filesize" -ge "$MAX_SIZE" ]; then
            # ignored_files_due_to_size="$ignored_files_due_to_size $filename"
            # ignored_files_due_to_size+=("$filename")
            echo "$filename" >> "$tmp_size"
        else
            for pattern in $patterns; do
                # if [[ "$filename" == $pattern ]]; then
                #     ignored_files_due_to_size="$ignored_files_due_to_size $filename" 
                # fi
                case "$filename" in
                    # $pattern) ignored_files_due_to_pattern="$ignored_files_due_to_pattern $filename" ;;
                    # $pattern) ignored_files_due_to_pattern+=("$filename"); echo "$filename" ;;
                    $pattern) echo "$filename" >> "$tmp_pattern" ;;
                esac
            done
        fi
    fi
done
#|%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%|#  
# Read the temporary files into arrays
while read -r line; do
    ignored_files_due_to_size+=("$line")
done < "$tmp_size"

while read -r line; do
    ignored_files_due_to_pattern+=("$line")
done < "$tmp_pattern"
#|++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++|#  
# Remove temporary files
rm "$tmp_size" "$tmp_pattern"
#|%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%|#  
# # Debugging statements
# echo "Ignored files due to size: ${ignored_files_due_to_size[@]}"
# echo "Ignored files due to pattern: ${ignored_files_due_to_pattern[@]}"
#|%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%|#  
# if [ -n "$ignored_files_due_to_size" ] || [ -n "$ignored_files_due_to_pattern" ]; then
#     echo "Some files are ignored due to their size or pattern specified in pre-commit hooks. If you need, use the following commands:"

#     if [ -n "$ignored_files_due_to_size" ]; then
#         echo "Files ignored due to size:"
#         for file in $ignored_files_due_to_size; do
#             echo "git add \"$file\""
#             echo "git commit -m \"Add and commit $file --no-verify\" --no-verify"
#         done
#     fi

#     if [ -n "$ignored_files_due_to_pattern" ]; then
#         echo "Files ignored due to pattern:"
#         for file in $ignored_files_due_to_pattern; do
#             echo "git add \"$file\""
#             echo "git commit -m \"Add and commit $file --no-verify\" --no-verify"
#         done
#     fi

#     done
#     exit 1
# fi
#|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|#  
# if [ ${#ignored_files_due_to_size[@]} -gt 0 ] || [ ${#ignored_files_due_to_pattern[@]} -gt 0 ]; then
#     echo "Some files are ignored due to their size or pattern specified in pre-commit hooks. If you need to commit these files, use the following commands:"
#     for file in "${ignored_files_due_to_size[@]}" "${ignored_files_due_to_pattern[@]}"; do
#         echo "git add \"$file\""
#         echo "git commit -m \"Add and commit $file --no-verify\" --no-verify"
#     done
    
#     exit 1
# fi
#|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|#  
if [ ${#ignored_files_due_to_size[@]} -gt 0 ] || [ ${#ignored_files_due_to_pattern[@]} -gt 0 ]; then
    echo "The following files are ignored due to their size or pattern and are not allowed to be committed:"

    if [ ${#ignored_files_due_to_size[@]} -gt 0 ]; then
        echo "Files ignored due to size:"
        for file in "${ignored_files_due_to_size[@]}"; do
            echo "git add \"$file\""
            echo "git commit -m \"Add and commit $file --no-verify\" --no-verify"
        done
    fi

    if [ ${#ignored_files_due_to_pattern[@]} -gt 0 ]; then
        echo "Files ignored due to pattern:"
        for file in "${ignored_files_due_to_pattern[@]}"; do
            echo "git add \"$file\""
            echo "git commit -m \"Add and commit $file --no-verify\" --no-verify"
        done
    fi

    exit 1
fi
#|________________________________________________________________________________|#  
#|%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%|#  
# Allow the commit if no large files are found
exit 0
#|________________________________________________________________________________|#  
#|%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%|#  
#|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|#  
#|++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++|#  
#|~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~|#  
#|________________________________________________________________________________|#  
#|%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%|#  
# Make the hook executable: Ensure the script is executable by running:
# chmod +x .git/hooks/pre-commit

# Force add and commit large files: If you need to commit a file larger than 10 MB, you can bypass (override) the hook by using the --no-verify option:
# git add path/to/largefile
# git commit -m "Add large file" --no-verify
