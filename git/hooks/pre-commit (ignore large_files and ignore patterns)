#!/bin/sh

# https://chatgpt.com/c/18230911-9003-42ad-9e3f-071c3310a148

# Maximum file size in bytes (10MB)
MAX_SIZE=$((10 * 1024 * 1024))

# List of file patterns to ignore (add your patterns here)
patterns="*.rda *.rda.* *.rds *.rds.* *.RData *.RData.* *.csv *.csv.* *.xls *.xls.* *.xlsx *.xlsx.*"

# Find files matching the patterns or exceeding the size limit
ignored_files=$(git diff --cached --name-only | while read -r filename; do
    # read -r: The read command treats backslashes as literal characters, preventing them from being interpreted as escape sequences. This is generally the desired behavior when reading filenames.
    if [ -f "$filename" ]; then
        # filesize=$(wc -c <"$filename")  # stat is faster than wc, but may not be available on all systems
        filesize=$(stat -c%s "$filename")  # stat is faster than wc, but may not be available on all systems
        if [ "$filesize" -ge "$MAX_SIZE" ]; then
            echo "$filename (size)"
        else
            for pattern in $patterns; do
                if [[ "$filename" == $pattern ]]; then
                    echo "$filename (pattern)"
                fi
            done
        fi
    fi
done)

if [ -n "$ignored_files" ]; then
    echo "The following files are ignored due to their size or pattern and are not allowed to be committed:"
    echo "$ignored_files"
    echo "If you need to commit these files, use 'git commit --no-verify'."
    exit 1
fi

# Allow the commit if no large files are found
exit 0

# Make the hook executable: Ensure the script is executable by running:
# chmod +x .git/hooks/pre-commit

# Force add and commit large files: If you need to commit a file larger than 10 MB, you can bypass (override) the hook by using the --no-verify option:
# git add path/to/largefile
# git commit -m "Add large file" --no-verify
