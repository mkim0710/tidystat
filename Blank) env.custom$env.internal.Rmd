---
# https://forum.posit.co/t/when-to-use-yaml-vs-when-to-use-setup-code-chunk/56169/
# The YAML approach allows you to set options globally for a specific output forma
# The setup chunk approach sets chunk options globally for the document regardless of the output format
title: "`r params$doc_title`"
author: "MHKim"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output:
  html_notebook:
    fig_height: 6
    fig_width: 10
    highlight: textmate
    toc: yes
    toc_depth: 6
    toc_float:
      collapsed: false
      smooth_scroll: false      
    number_sections: false
    # df_print: tibble
  word_document:
    fig_height: 6
    fig_width: 9
    toc: no
  pdf_document:
    fig_height: 6
    fig_width: 10
    toc: no
params:
  doc_title: !r basename(rstudioapi::getSourceEditorContext()$path)
# https://stackoverflow.com/questions/55751815/r-markdown-difference-between-parameters-and-variables
# The advantage of utilizing parameters is that you can pass these values to a call to the render() function.
---

<!-- font-size: 0.9em; /* 90% of inherited font size */ -->

<!-- Body text (body): The default font size is typically 16 pixels. -->
<!-- Paragraphs (p): Inherit the body's font size, so also typically 16 pixels. -->
<!-- List items (li): Inherit the body's font size, generally 16 pixels. -->
<!-- Headings (h1 to h6): The default sizes decrease with each level. For example: -->
<!-- h1: Typically around 32 pixels. -->
<!-- h2: Often around 24 pixels. -->
<!-- h3: Commonly around 18.72 pixels. -->
<!-- h4: Usually about 16 pixels. -->
<!-- h5: Generally around 13.28 pixels. -->
<!-- h6: Often about 10.72 pixels. -->
<!-- Blockquotes (blockquote): Usually inherit the body's font size, around 16 pixels. -->
<!-- Tables (table), table cells (td, th): Typically inherit the body's font size, so around 16 pixels. -->
<!-- Figures (figure) and figure captions (figcaption): Generally inherit the body's font size, so about 16 pixels. -->
<!-- 1: Approximately 8 pixels. -->
<!-- 2: Approximately 10 pixels. -->
<!-- 3: Approximately 12 pixels (this was often considered the default size). -->
<!-- 4: Approximately 14 pixels. -->
<!-- 5: Approximately 18 pixels. -->
<!-- 6: Approximately 24 pixels. -->
# _______________
```{markdown Rstudio-RMarkDown-Shortcuts, include=FALSE, eval=FALSE} 
##### Rstudio RMarkDown Shortcuts
https://support.posit.co/hc/en-us/articles/200711853-Keyboard-Shortcuts-in-the-RStudio-IDE  
https://bookdown.org/yihui/rmarkdown-cookbook/rstudio-shortcuts.html  
Insert R chunk	Ctrl+Alt+I	Command+Option+I\
Preview HTML	Ctrl+Shift+K	Command+Shift+K\
Run all chunks above	Ctrl+Alt+P	Command+Option+P\
Run current chunk	Ctrl+Alt+C	Command+Option+C\
Run current chunk	Ctrl+Shift+Enter	Command+Shift+Enter\
Run next chunk	Ctrl+Alt+N	Command+Option+N\
Run all chunks	Ctrl+Alt+R	Command+Option+R\
Go to next chunk/title	Ctrl+PgDown	Command+PgDown\
Go to previous chunk/title	Ctrl+PgUp	Command+PgUp\
Show/hide document outline	Ctrl+Shift+O	Command+Shift+O\
F7 spell-check your document.\
Restart the R session   Ctrl + Alt + F10 (or Command + Option + F10 on macOS).\
\
```


```{r setup, include=FALSE}
# str(knitr::opts_chunk$get())
knitr::opts_chunk$set(
  comment = '##', fig.width = 10, fig.height = 6, 
  collapse=TRUE, results='hold', 
  # echo=TRUE, message=TRUE, warning=TRUE, error=TRUE,
  tidy.opts=list(width.cutoff=80), tidy=TRUE
)
knitr::opts_knit$set(global.par = TRUE)

```


```{r loadPackages, include=FALSE}
suppressPackageStartupMessages({for (packagename in c("tidyverse")) {if (!require(packagename, character.only = TRUE)) install.packages(packagename); library(packagename, character.only = TRUE)}}); cat("\r\n");
source(file.path("D:/OneDrive/[][Rproject]/github_tidystat", "env.custom$env.internal.source.r"))
objectname = "f_df.t.tribble_construct"
source(file.path(file.path(env.custom$path$source_base_local, ""), paste0(objectname, ".source.r")) )
# source(file.path("https://github.com/mkim0710/tidystat/raw/master", "env.custom$env.internal.source.r"))
```


<font size="3">\% env.custom</font>\
<font size="3">\% env.custom\$info</font>\

#### \% env.custom\$DocumentTitle1
```{r envCustom-DocumentTitle1, paged.print=FALSE, collapse=TRUE, echo=FALSE, message=FALSE, results=FALSE}
# https://yihui.org/knitr/options/#package-options

if(!exists("env.custom", envir = .GlobalEnv)) assign("env.custom", new.env(), envir = .GlobalEnv)
if(!"info" %in% names(env.custom)) env.custom$info = list()
env.custom$info$DocumentTitle0 = paste0("Blank) env.custom$env.internal", ") ", basename(getwd()))
env.custom$info$DocumentTitle1 = paste0(env.custom$info$DocumentTitle0,"@", ifelse(grepl("MacBook-Pro", Sys.info()["nodename"]), "MBP", Sys.info()["nodename"]))
cat(env.custom$info$DocumentTitle0, " ", format(Sys.time(), '%y%m%d'), "\r\n", 
    env.custom$info$DocumentTitle0, " ", format(Sys.time(), '%y%m%d'), ".r", "\r\n", 
    env.custom$info$DocumentTitle0, " ", format(Sys.time(), '%y%m%d'), " -dev.r", "\r\n", 
    env.custom$info$DocumentTitle0, " ", format(Sys.time(), '%y%m%d'), " -clean.r", "\r\n", 
    env.custom$info$DocumentTitle0, " ", format(Sys.time(), '%y%m%d'), ".Rmd", "\r\n", 
    env.custom$info$DocumentTitle0, " ", format(Sys.time(), '%y%m%d'), " -dev.Rmd", "\r\n", 
    env.custom$info$DocumentTitle0, " ", format(Sys.time(), '%y%m%d'), " -clean.Rmd", "\r\n", 
    sep = "")
```


#### \% env.custom\$info\$info_system_info
```{r envCustom-Info, paged.print=FALSE, collapse=TRUE, echo=FALSE, message=FALSE, results=FALSE}

# @ source(file.path(file.path(env.custom$path$source_base_local, ""), paste0(objectname, ".source.r")) ) ----
objectname = "get_system_info"
source(file.path(file.path(env.custom$path$source_base_local, ""), paste0(objectname, ".source.r")) )
env.custom$info$info_system_info = env.custom$info$get_system_info()
# str(env.custom$info$info_system_info)
text4parse = "env.custom$info$info_system_info$machine_nodename"; cat(text4parse, ' = "', eval(parse(text = text4parse)), '"', "\n", sep = "")
text4parse = "env.custom$info$info_system_info$Sys.getlocale$LC_COLLATE"; cat(text4parse, ' = "', eval(parse(text = text4parse)), '"', "\n", sep = "")
# text4parse = "env.custom$info$info_system_info$l10n_info$localization_UTF8"; cat(text4parse, ' = "', eval(parse(text = text4parse)), '"', "\n", sep = "")

env.custom$info$info_software_versions = env.custom$info$get_software_versions(
    library_names = c("tidyverse", "dplyr", "ggplot2", "purrr", "stringr",
                      "datapasta")
)
# str(env.custom$info$info_software_versions)
```


################################################
#### \% env.custom\$path    
<font size="2">\% env.custom\$path\$data_suffix</font>\
<font size="2">\% env.custom\$path\$project_suffix</font>\
```{r envCustom-Path, paged.print=FALSE, collapse=TRUE, echo=FALSE}
# cat("\r\n"); 
# source(file.path("D:/OneDrive/[][Rproject]/github_tidystat", "env.custom$env.internal.source.r"))
cat("getwd() == "); dput(getwd()) #----
# env.custom$path$project_base = "Rproject_HEALS0215"
# env.custom$path$data_suffix = "_01"
# # env.custom$path$data_suffix = ""
# env.custom$path$project_suffix = "GJ3"
# 
# env.custom$path$path4read = file.path(env.custom$path$path0, paste0(env.custom$path$project_base, env.custom$path$data_suffix))
# env.custom$path$path4write = file.path(env.custom$path$path4read, paste0(env.custom$path$project_base, env.custom$path$data_suffix, env.custom$path$project_suffix))
env.custom$path$path4read = ifelse(is.na(env.custom$path$path1), getwd(), env.custom$path$path1)
env.custom$path$path4write = getwd()
cat("> str(env.custom$path)\n"); str(env.custom$path, max.level = 1, give.attr = F)  
path4read  = env.custom$path$path4read
path4write = env.custom$path$path4write
if (getwd() != path4read) warning("getwd() != path4read == ") else cat("getwd() == path4read == "); dput(path4read)  #----
if (getwd() != path4write) warning("getwd() != path4write  == ") else cat("getwd() == path4write == "); dput(path4write)  #----
```


##### \% f_path.df_dirs_recursive.df_files()
```{r dfDIRsRecursive, paged.print=FALSE, collapse=TRUE, echo=FALSE, message=FALSE, results=FALSE}

# @ source(file.path(file.path(env.custom$path$source_base_local, ""), paste0(objectname, ".source.r")) ) ----
objectname = "f_path.df_dirs_recursive.df_files"
source(file.path(file.path(env.custom$path$source_base_local, ""), paste0(objectname, ".source.r")) )


f_path.df_dirs_recursive.df_files = env.custom$f_path.df_dirs_recursive.df_files
env.custom$path$df_dirs_recursive.df_files =
    f_path.df_dirs_recursive.df_files(input_path = ".")
env.custom$path$print_tree_path =
    env.custom$path$df_dirs_recursive.df_files %>% 
    filter(path.level <= 5) %>%
    dplyr::select(print_tree_path) %>%
    unlist %>% paste(collapse = "") 
# env.custom$path$print_tree_path %>% cat
env.custom$path$print_tree_path_files.r =
    env.custom$path$df_dirs_recursive.df_files %>% 
    filter(path.level <= 2) %>%
    dplyr::select(print_tree_path_files.r) %>%
    unlist %>% paste(collapse = "") 
# env.custom$path$print_tree_path_files.r %>% cat
env.custom$path$print_tree_path_files.rmd =
    env.custom$path$df_dirs_recursive.df_files %>% 
    filter(path.level <= 2) %>%
    dplyr::select(print_tree_path_files.rmd) %>%
    unlist %>% paste(collapse = "") 
env.custom$path$print_tree_path_files.data =
    env.custom$path$df_dirs_recursive.df_files %>% 
    filter(path.level <= 2) %>%
    dplyr::select(print_tree_path_files.data) %>%
    unlist %>% paste(collapse = "") 
cat("\r\n")
# env.custom$path$print_tree_path_files.rmd %>% cat
env.custom$path$print_tree_path_files.data %>% cat
```


##### \% env.custom\$f_path.size_files() ====
```{r sizeFiles, paged.print=FALSE, collapse=TRUE, echo=FALSE, message=FALSE, results=FALSE}

# @ source(file.path(file.path(env.custom$path$source_base_local, ""), paste0(objectname, ".source.r")) ) ----
objectname = "f_path.size_files"
source(file.path(file.path(env.custom$path$source_base_local, ""), paste0(objectname, ".source.r")) )
if (getwd() != path4read) warning("getwd() != path4read == ") else cat("getwd() == path4read == "); dput(path4read)  #----
env.custom$f_path.size_files(path4read = path4read)
```

# @@ START ------

# $ objectname = "tblID_gj3_jk" ====
@ assign(objectname, readRDS(file.path(path4read, filename2read))) 
```{r, paged.print=FALSE, collapse=TRUE}

# @ source(file.path(file.path(env.custom$path$source_base_local, ""), paste0(objectname, ".source.r")) ) ----
objectname = "f_objectname.read.checkEntity"
source(file.path(file.path(env.custom$path$source_base_local, ""), paste0(objectname, ".source.r")) )

objectname = "tblID_gj3_jk"
env.custom$f_objectname.read.checkEntity(objectname = objectname, ext = "rds", path4read = ".")
```


```{r, paged.print=FALSE, collapse=TRUE, echo=TRUE, message=TRUE, results='hold', comment = '##'}

```


```{r, paged.print=FALSE, collapse=TRUE}

```


```{r, paged.print=FALSE, collapse=TRUE}

```


```{r, paged.print=FALSE, collapse=TRUE}

```


```{r, paged.print=FALSE, collapse=TRUE}

```


```{r, paged.print=FALSE, collapse=TRUE}

```


```{r, paged.print=FALSE, collapse=TRUE}

```


```{r, paged.print=FALSE, collapse=TRUE}

```


```{r, paged.print=FALSE, collapse=TRUE}

```


```{r, paged.print=FALSE, collapse=TRUE}

```


```{r, paged.print=FALSE, collapse=TRUE}

```


```{r, paged.print=FALSE, collapse=TRUE}

```


```{r, paged.print=FALSE, collapse=TRUE}

```


```{r, paged.print=FALSE, collapse=TRUE}

```


```{r, paged.print=FALSE, collapse=TRUE}

```


# [Plot] Stratified Kaplan-Meier Survival Curve
```{r plotWidth8Height6, paged.print=FALSE, fig.width=8, fig.height=6, echo=FALSE, message=FALSE, results=FALSE}
library(tidyverse)
# library(survival)
# library(survminer)
?survival::lung
analyticDF_time2event = survival::lung %>% mutate(event = as.logical(status-1), Group = c("Male", "Female")[sex] %>% as.factor, StudyPopulation = time >= 30) %>% dplyr::select(-status, -sex) %>% as_tibble
# analyticDF_time2event %>% dplyr::select(sex, Group) %>% str
# analyticDF_time2event %>% dplyr::select(sex, Group) %>% table
# # > analyticDF_time2event %>% dplyr::select(sex, Group) %>% str
# # 'data.frame':	228 obs. of  2 variables:
# #  $ sex  : num  1 1 1 1 1 1 2 2 1 1 ...
# #  $ Group: Factor w/ 2 levels "Female","Male": 2 2 2 2 2 2 1 1 2 2 ...
# # > analyticDF_time2event %>% dplyr::select(sex, Group) %>% table
# #    Group
# # sex Female Male
# #   1      0  138
# #   2     90    0
analyticDF_time2event %>% dplyr::select(time, event, Group, StudyPopulation) %>% by(.$StudyPopulation, summary)
# > analyticDF_time2event %>% dplyr::select(time, event, Group, StudyPopulation) %>% by(.$StudyPopulation, summary)
# .$StudyPopulation: FALSE
#       time     event            Group   StudyPopulation
#  Min.   : 5   Mode:logical   Female:1   Mode :logical  
#  1st Qu.:11   TRUE:9         Male  :8   FALSE:9        
#  Median :12                                            
#  Mean   :13                                            
#  3rd Qu.:13                                            
#  Max.   :26                                            
# --------------------------------------------------------------------------------------------------------------------------------------------- 
# .$StudyPopulation: TRUE
#       time          event            Group     StudyPopulation
#  Min.   :  30.0   Mode :logical   Female: 89   Mode:logical   
#  1st Qu.: 176.5   FALSE:63        Male  :130   TRUE:219       
#  Median : 269.0   TRUE :156                                   
#  Mean   : 317.2                                               
#  3rd Qu.: 419.5                                               
#  Max.   :1022.0   

?survminer::ggsurvplot  # "event" plots cumulative events (f(y) = 1-y), "cumhaz" plots the cumulative hazard function (f(y) = -log(y)), and "pct" for survival probability in percentage.
# analyticDF_time2event.survfit %>% ggsurvplot(fun = "pct")  # default fun = "pct"?
# analyticDF_time2event.survfit %>% ggsurvplot(fun = "event")
# analyticDF_time2event.survfit %>% ggsurvplot(fun = "cumhaz")  # Cumulative Hazard = -log S(t)
value_for_Censor_at_END = 365 * 1
value_for_break.time.by = 30
time_scale = "days"
varname4Group = "Group"
analyticDF_time2event.CensorEND = analyticDF_time2event %>%
    mutate(
        time = time %>% replace_na(Inf)
        # , event = event %>% replace_na(F)
    ) %>%
    # mutate(event.CensorEND = ifelse(time <= value_for_Censor_at_END, event, F)) %>%
    # mutate(time.CensorEND = pmin(time, value_for_Censor_at_END)) %>%
    mutate(event = ifelse(time <= value_for_Censor_at_END, event, F)) %>%
    mutate(time = pmin(time, value_for_Censor_at_END)) %>%
    as_tibble
analyticDF_time2event.CensorEND %>% dplyr::select(time, event, Group, StudyPopulation) %>% by(.$StudyPopulation, summary)
# > analyticDF_time2event.CensorEND %>% dplyr::select(time, event, Group, StudyPopulation) %>% by(.$StudyPopulation, summary)
# .$StudyPopulation: FALSE
#       time     event            Group   StudyPopulation
#  Min.   : 5   Mode:logical   Female:1   Mode :logical  
#  1st Qu.:11   TRUE:9         Male  :8   FALSE:9        
#  Median :12                                            
#  Mean   :13                                            
#  3rd Qu.:13                                            
#  Max.   :26                                            
# --------------------------------------------------------------------------------------------------------------------------------------------- 
# .$StudyPopulation: TRUE
#       time         event            Group     StudyPopulation
#  Min.   : 30.0   Mode :logical   Female: 89   Mode:logical   
#  1st Qu.:176.5   FALSE:107       Male  :130   TRUE:219       
#  Median :269.0   TRUE :112                                   
#  Mean   :253.6                                               
#  3rd Qu.:365.0                                               
#  Max.   :365.0                                               
survminer::ggsurvplot(survival::survfit(survival::Surv(time = time, event = event) ~ Group, data = analyticDF_time2event.CensorEND %>% filter(StudyPopulation) %>% dplyr::select(-StudyPopulation)), palette = c("#00AFBB", "#FC4E07")
           , break.time.by = value_for_break.time.by
           , conf.int = TRUE, risk.table = TRUE, pval = TRUE
           , xlim = c(0, value_for_Censor_at_END), ylim = c(0, 1)
           , title = paste0("Survival Curves Stratified by ", varname4Group)
           , xlab = paste0("Time in ", time_scale), ylab = "Survival Probability")

```


# @@ END -----
```{r END, paged.print=FALSE, collapse=TRUE, echo=FALSE, message=FALSE, results=FALSE}
# @@ END -----
```

# $ objectname = "AnalyticDataset200621" ====

###### @ write_rds( get(objectname), file.path(path4write, paste0(objectname, ".rds"))) -----
```{r writeRDS, paged.print=FALSE, collapse=TRUE, echo=FALSE, message=FALSE, results=FALSE}
# 
# @ write_rds( get(objectname), file.path(path4write, paste0(objectname, ".rds"))) -----
# objectname = "AnalyticDataset200621"
# system.time(write_rds( get(objectname),paste0(objectname, ".rds")))
# # system.time(write_rds( get(objectname), file.path(path4write, paste0(objectname, ".rds"))))
# # system.time(write_rds( get(objectname), file.path(path4write, paste0(objectname, ".rds")), compress = "gz" ))
# # system.time(write_rds( get(objectname), file.path(path4write, paste0(objectname, ".rds", "")), compress = "xz", compression = 9 ))
# # openxlsx::write.xlsx(get(objectname), file = paste0(objectname, ".xlsx"), asTable = T, withFilter = T)
# # openxlsx::openXL(paste0(objectname, ".xlsx"))
```


